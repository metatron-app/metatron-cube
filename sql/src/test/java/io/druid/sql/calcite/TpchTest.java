/*
 * Licensed to SK Telecom Co., LTD. (SK Telecom) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  SK Telecom licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

package io.druid.sql.calcite;

import io.druid.data.ValueDesc;
import io.druid.java.util.common.logger.Logger;
import io.druid.query.aggregation.CountAggregatorFactory;
import io.druid.query.aggregation.GenericSumAggregatorFactory;
import io.druid.query.aggregation.post.ArithmeticPostAggregator;
import io.druid.query.aggregation.post.FieldAccessPostAggregator;
import io.druid.query.dimension.DefaultDimensionSpec;
import io.druid.query.filter.BoundDimFilter;
import io.druid.query.groupby.orderby.LimitSpec;
import io.druid.query.groupby.orderby.OrderByColumnSpec;
import io.druid.segment.TestIndex;
import io.druid.sql.calcite.util.TestQuerySegmentWalker;
import org.junit.BeforeClass;
import org.junit.Test;

import java.util.Arrays;

// the problem is.. some queries containing join return empty cause dataset is too small (s=0.005)
public class TpchTest extends CalciteQueryTestHelper
{
  private static final Logger log = new Logger(TpchTest.class);

  private static TestQuerySegmentWalker walker = null;

  @BeforeClass
  public static void setUp() throws Exception
  {
    walker = TestIndex.segmentWalker.duplicate();
    walker.populate("lineitem");
    walker.populate("orders");
    walker.populate("customer");
    walker.populate("nation");
    walker.populate("part");
    walker.populate("partsupp");
    walker.populate("region");
    walker.populate("supplier");
  }

  @Override
  protected TestQuerySegmentWalker walker()
  {
    return walker;
  }

  @Test
  public void tpch1() throws Exception
  {
    testQuery(
        "SELECT\n"
        + "    L_RETURNFLAG,\n"
        + "    L_LINESTATUS,\n"
        + " SUM(L_QUANTITY) AS SUM_QTY,\n"
        + " SUM(L_EXTENDEDPRICE) AS SUM_BASE_PRICE,\n"
        + " SUM(L_EXTENDEDPRICE * (1 - L_DISCOUNT)) AS SUM_DISC_PRICE,\n"
        + " SUM(L_EXTENDEDPRICE * (1 - L_DISCOUNT) * (1 + L_TAX)) AS SUM_CHARGE,\n"
        + " AVG(L_QUANTITY) AS AVG_QTY,\n"
        + " AVG(L_EXTENDEDPRICE) AS AVG_PRICE,\n"
        + " AVG(L_DISCOUNT) AS AVG_DISC,\n"
        + " COUNT(*) AS COUNT_ORDER\n"
        + " FROM\n"
        + "    lineitem\n"
        + " WHERE\n"
        + "    L_SHIPDATE <= '1998-09-16'\n"
        + " GROUP BY\n"
        + "    L_RETURNFLAG,\n"
        + "    L_LINESTATUS\n"
        + " ORDER BY\n"
        + "    L_RETURNFLAG,\n"
        + "    L_LINESTATUS",
        newGroupBy()
            .dataSource("lineitem")
            .dimensions(
                DefaultDimensionSpec.of("L_RETURNFLAG", "d0"),
                DefaultDimensionSpec.of("L_LINESTATUS", "d1")
            )
            .filters(BoundDimFilter.lte("L_SHIPDATE", "1998-09-16").withComparatorType("lexicographic"))
            .aggregators(
                GenericSumAggregatorFactory.ofLong("a0", "L_QUANTITY"),
                GenericSumAggregatorFactory.ofDouble("a1", "L_EXTENDEDPRICE"),
                GenericSumAggregatorFactory.expr(
                    "a2",
                    "(\"L_EXTENDEDPRICE\" * (1 - \"L_DISCOUNT\"))",
                    ValueDesc.DOUBLE
                ),
                GenericSumAggregatorFactory.expr(
                    "a3",
                    "((\"L_EXTENDEDPRICE\" * (1 - \"L_DISCOUNT\")) * (1 + \"L_TAX\"))",
                    ValueDesc.DOUBLE
                ),
                GenericSumAggregatorFactory.ofLong("a4:sum", "L_QUANTITY"),
                CountAggregatorFactory.of("a4:count"),
                GenericSumAggregatorFactory.ofDouble("a5:sum", "L_EXTENDEDPRICE"),
                CountAggregatorFactory.of("a5:count"),
                GenericSumAggregatorFactory.ofDouble("a6:sum", "L_DISCOUNT"),
                CountAggregatorFactory.of("a6:count"),
                CountAggregatorFactory.of("a7")
            )
            .postAggregators(
                new ArithmeticPostAggregator("a4", "quotient", Arrays.asList(
                    new FieldAccessPostAggregator(null, "a4:sum"),
                    new FieldAccessPostAggregator(null, "a4:count")
                )),
                new ArithmeticPostAggregator("a5", "quotient", Arrays.asList(
                    new FieldAccessPostAggregator(null, "a5:sum"),
                    new FieldAccessPostAggregator(null, "a5:count")
                )),
                new ArithmeticPostAggregator("a6", "quotient", Arrays.asList(
                    new FieldAccessPostAggregator(null, "a6:sum"),
                    new FieldAccessPostAggregator(null, "a6:count")
                ))
            )
            .limitSpec(LimitSpec.of(
                OrderByColumnSpec.asc("d0"),
                OrderByColumnSpec.asc("d1")
            ))
            .outputColumns("d0", "d1", "a0", "a1", "a2", "a3", "a4", "a5", "a6", "a7")
            .build(),
        new Object[]{"A", "F", 189203L, 2.649171512299999E8, 2.5172256669044656E8, 2.618137696907937E8, 25L, 35407.26426490242, 0.05014435F, 7482L},
        new Object[]{"N", "F", 4654L, 6647990.519999999, 6333568.496621376, 6584905.261532691, 26L, 37139.61184357541, 0.04849162F, 179L},
        new Object[]{"N", "O", 376815L, 5.2792684456999964E8, 5.016250502495867E8, 5.2164760657695186E8, 25L, 35840.247424983005, 0.04984861F, 14730L},
        new Object[]{"R", "F", 191214L, 2.6792430413999987E8, 2.5454761805335242E8, 2.6480436570269588E8, 25L, 35972.65093179375, 0.04983217F, 7448L}
    );
  }

  @Test
  public void tpch2() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH q2_min_ps_supplycost AS (\n"
        + "SELECT\n"
        + "    P_PARTKEY AS MIN_P_PARTKEY,\n"
        + " MIN(PS_SUPPLYCOST) AS MIN_PS_SUPPLYCOST\n"
        + " FROM\n"
        + "    part,\n"
        + "    partsupp,\n"
        + "    supplier,\n"
        + "    nation,\n"
        + "    region\n"
        + " WHERE\n"
        + "    P_PARTKEY = PS_PARTKEY\n"
        + " AND S_SUPPKEY = PS_SUPPKEY\n"
        + " AND S_NATIONKEY = N_NATIONKEY\n"
        + " AND N_REGIONKEY = R_REGIONKEY\n"
        + " AND R_NAME = 'EUROPE'\n"
        + " GROUP BY\n"
        + "    P_PARTKEY\n"
        + ")\n"
        + "SELECT\n"
        + "    S_ACCTBAL,\n"
        + "    S_NAME,\n"
        + "    N_NAME,\n"
        + "    P_PARTKEY,\n"
        + "    P_MFGR,\n"
        + "    S_ADDRESS,\n"
        + "    S_PHONE,\n"
        + "    S_COMMENT\n"
        + " FROM\n"
        + "    part,\n"
        + "    supplier,\n"
        + "    partsupp,\n"
        + "    nation,\n"
        + "    region,\n"
        + "    q2_min_ps_supplycost\n"
        + " WHERE\n"
        + "    P_PARTKEY = PS_PARTKEY\n"
        + " AND S_SUPPKEY = PS_SUPPKEY\n"
        + " AND P_SIZE = 37\n"
        + " AND P_TYPE LIKE '%COPPER'\n"
        + " AND S_NATIONKEY = N_NATIONKEY\n"
        + " AND N_REGIONKEY = R_REGIONKEY\n"
        + " AND R_NAME = 'EUROPE'\n"
        + " AND PS_SUPPLYCOST = MIN_PS_SUPPLYCOST\n"
        + " AND P_PARTKEY = MIN_P_PARTKEY\n"
        + " ORDER BY\n"
        + "    S_ACCTBAL DESC,\n"
        + "    N_NAME,\n"
        + "    S_NAME,\n"
        + "    P_PARTKEY\n"
        + " LIMIT 100",
        "{\n"
        + "  \"queryType\" : \"select.stream\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"part+partsupp+supplier+nation+region$\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"groupBy\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"part+partsupp+supplier+nation\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"join\",\n"
        + "                      \"dataSources\" : {\n"
        + "                        \"part+partsupp+supplier\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"join\",\n"
        + "                            \"dataSources\" : {\n"
        + "                              \"supplier\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"select.stream\",\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"table\",\n"
        + "                                    \"name\" : \"supplier\"\n"
        + "                                  },\n"
        + "                                  \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                                  \"limitSpec\" : {\n"
        + "                                    \"type\" : \"noop\"\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              },\n"
        + "                              \"part+partsupp\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"join\",\n"
        + "                                  \"dataSources\" : {\n"
        + "                                    \"partsupp\" : {\n"
        + "                                      \"type\" : \"query\",\n"
        + "                                      \"query\" : {\n"
        + "                                        \"queryType\" : \"select.stream\",\n"
        + "                                        \"dataSource\" : {\n"
        + "                                          \"type\" : \"table\",\n"
        + "                                          \"name\" : \"partsupp\"\n"
        + "                                        },\n"
        + "                                        \"columns\" : [ \"PS_PARTKEY\", \"PS_SUPPKEY\", \"PS_SUPPLYCOST\" ],\n"
        + "                                        \"limitSpec\" : {\n"
        + "                                          \"type\" : \"noop\"\n"
        + "                                        }\n"
        + "                                      }\n"
        + "                                    },\n"
        + "                                    \"part\" : {\n"
        + "                                      \"type\" : \"query\",\n"
        + "                                      \"query\" : {\n"
        + "                                        \"queryType\" : \"select.stream\",\n"
        + "                                        \"dataSource\" : {\n"
        + "                                          \"type\" : \"table\",\n"
        + "                                          \"name\" : \"part\"\n"
        + "                                        },\n"
        + "                                        \"columns\" : [ \"P_PARTKEY\" ],\n"
        + "                                        \"limitSpec\" : {\n"
        + "                                          \"type\" : \"noop\"\n"
        + "                                        }\n"
        + "                                      }\n"
        + "                                    }\n"
        + "                                  },\n"
        + "                                  \"elements\" : [ {\n"
        + "                                    \"joinType\" : \"INNER\",\n"
        + "                                    \"leftAlias\" : \"part\",\n"
        + "                                    \"leftJoinColumns\" : [ \"P_PARTKEY\" ],\n"
        + "                                    \"rightAlias\" : \"partsupp\",\n"
        + "                                    \"rightJoinColumns\" : [ \"PS_PARTKEY\" ]\n"
        + "                                  } ],\n"
        + "                                  \"asArray\" : true,\n"
        + "                                  \"limit\" : 0,\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"union\",\n"
        + "                                    \"dataSources\" : [ \"part\", \"partsupp\" ]\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              }\n"
        + "                            },\n"
        + "                            \"elements\" : [ {\n"
        + "                              \"joinType\" : \"INNER\",\n"
        + "                              \"leftAlias\" : \"part+partsupp\",\n"
        + "                              \"leftJoinColumns\" : [ \"PS_SUPPKEY\" ],\n"
        + "                              \"rightAlias\" : \"supplier\",\n"
        + "                              \"rightJoinColumns\" : [ \"S_SUPPKEY\" ]\n"
        + "                            } ],\n"
        + "                            \"asArray\" : true,\n"
        + "                            \"limit\" : 0,\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"union\",\n"
        + "                              \"dataSources\" : [ \"part+partsupp\", \"supplier\" ]\n"
        + "                            }\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"nation\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"select.stream\",\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"table\",\n"
        + "                              \"name\" : \"nation\"\n"
        + "                            },\n"
        + "                            \"columns\" : [ \"N_NATIONKEY\", \"N_REGIONKEY\" ],\n"
        + "                            \"limitSpec\" : {\n"
        + "                              \"type\" : \"noop\"\n"
        + "                            }\n"
        + "                          }\n"
        + "                        }\n"
        + "                      },\n"
        + "                      \"elements\" : [ {\n"
        + "                        \"joinType\" : \"INNER\",\n"
        + "                        \"leftAlias\" : \"part+partsupp+supplier\",\n"
        + "                        \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "                        \"rightAlias\" : \"nation\",\n"
        + "                        \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "                      } ],\n"
        + "                      \"asArray\" : true,\n"
        + "                      \"limit\" : 0,\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"union\",\n"
        + "                        \"dataSources\" : [ \"part+partsupp+supplier\", \"nation\" ]\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"region\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"region\"\n"
        + "                      },\n"
        + "                      \"filter\" : {\n"
        + "                        \"type\" : \"selector\",\n"
        + "                        \"dimension\" : \"R_NAME\",\n"
        + "                        \"value\" : \"EUROPE\"\n"
        + "                      },\n"
        + "                      \"columns\" : [ \"R_NAME\", \"R_REGIONKEY\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      }\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"INNER\",\n"
        + "                  \"leftAlias\" : \"part+partsupp+supplier+nation\",\n"
        + "                  \"leftJoinColumns\" : [ \"N_REGIONKEY\" ],\n"
        + "                  \"rightAlias\" : \"region\",\n"
        + "                  \"rightJoinColumns\" : [ \"R_REGIONKEY\" ]\n"
        + "                } ],\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"part+partsupp+supplier+nation\", \"region\" ]\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"dimensions\" : [ {\n"
        + "              \"type\" : \"default\",\n"
        + "              \"dimension\" : \"P_PARTKEY\",\n"
        + "              \"outputName\" : \"d0\"\n"
        + "            } ],\n"
        + "            \"aggregations\" : [ {\n"
        + "              \"type\" : \"min\",\n"
        + "              \"name\" : \"a0\",\n"
        + "              \"fieldName\" : \"PS_SUPPLYCOST\",\n"
        + "              \"inputType\" : \"double\"\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"d0\", \"a0\" ]\n"
        + "          }\n"
        + "        },\n"
        + "        \"part+partsupp+supplier+nation+region\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"part+partsupp+supplier+nation\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"part+partsupp+supplier\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"join\",\n"
        + "                            \"dataSources\" : {\n"
        + "                              \"supplier\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"select.stream\",\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"table\",\n"
        + "                                    \"name\" : \"supplier\"\n"
        + "                                  },\n"
        + "                                  \"columns\" : [ \"S_ACCTBAL\", \"S_ADDRESS\", \"S_COMMENT\", \"S_NAME\", \"S_NATIONKEY\", \"S_PHONE\", \"S_SUPPKEY\" ],\n"
        + "                                  \"limitSpec\" : {\n"
        + "                                    \"type\" : \"noop\"\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              },\n"
        + "                              \"part+partsupp\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"join\",\n"
        + "                                  \"dataSources\" : {\n"
        + "                                    \"partsupp\" : {\n"
        + "                                      \"type\" : \"query\",\n"
        + "                                      \"query\" : {\n"
        + "                                        \"queryType\" : \"select.stream\",\n"
        + "                                        \"dataSource\" : {\n"
        + "                                          \"type\" : \"table\",\n"
        + "                                          \"name\" : \"partsupp\"\n"
        + "                                        },\n"
        + "                                        \"columns\" : [ \"PS_PARTKEY\", \"PS_SUPPKEY\", \"PS_SUPPLYCOST\" ],\n"
        + "                                        \"limitSpec\" : {\n"
        + "                                          \"type\" : \"noop\"\n"
        + "                                        }\n"
        + "                                      }\n"
        + "                                    },\n"
        + "                                    \"part\" : {\n"
        + "                                      \"type\" : \"query\",\n"
        + "                                      \"query\" : {\n"
        + "                                        \"queryType\" : \"select.stream\",\n"
        + "                                        \"dataSource\" : {\n"
        + "                                          \"type\" : \"table\",\n"
        + "                                          \"name\" : \"part\"\n"
        + "                                        },\n"
        + "                                        \"filter\" : {\n"
        + "                                          \"type\" : \"and\",\n"
        + "                                          \"fields\" : [ {\n"
        + "                                            \"type\" : \"selector\",\n"
        + "                                            \"dimension\" : \"P_SIZE\",\n"
        + "                                            \"value\" : \"37\"\n"
        + "                                          }, {\n"
        + "                                            \"type\" : \"like\",\n"
        + "                                            \"dimension\" : \"P_TYPE\",\n"
        + "                                            \"pattern\" : \"%COPPER\"\n"
        + "                                          } ]\n"
        + "                                        },\n"
        + "                                        \"columns\" : [ \"P_MFGR\", \"P_PARTKEY\", \"P_SIZE\", \"P_TYPE\" ],\n"
        + "                                        \"limitSpec\" : {\n"
        + "                                          \"type\" : \"noop\"\n"
        + "                                        }\n"
        + "                                      }\n"
        + "                                    }\n"
        + "                                  },\n"
        + "                                  \"elements\" : [ {\n"
        + "                                    \"joinType\" : \"INNER\",\n"
        + "                                    \"leftAlias\" : \"part\",\n"
        + "                                    \"leftJoinColumns\" : [ \"P_PARTKEY\" ],\n"
        + "                                    \"rightAlias\" : \"partsupp\",\n"
        + "                                    \"rightJoinColumns\" : [ \"PS_PARTKEY\" ]\n"
        + "                                  } ],\n"
        + "                                  \"asArray\" : true,\n"
        + "                                  \"limit\" : 0,\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"union\",\n"
        + "                                    \"dataSources\" : [ \"part\", \"partsupp\" ]\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              }\n"
        + "                            },\n"
        + "                            \"elements\" : [ {\n"
        + "                              \"joinType\" : \"INNER\",\n"
        + "                              \"leftAlias\" : \"part+partsupp\",\n"
        + "                              \"leftJoinColumns\" : [ \"PS_SUPPKEY\" ],\n"
        + "                              \"rightAlias\" : \"supplier\",\n"
        + "                              \"rightJoinColumns\" : [ \"S_SUPPKEY\" ]\n"
        + "                            } ],\n"
        + "                            \"asArray\" : true,\n"
        + "                            \"limit\" : 0,\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"union\",\n"
        + "                              \"dataSources\" : [ \"part+partsupp\", \"supplier\" ]\n"
        + "                            }\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"columns\" : [ \"P_MFGR\", \"P_PARTKEY\", \"P_SIZE\", \"P_TYPE\", \"S_ACCTBAL\", \"S_ADDRESS\", \"S_COMMENT\", \"S_NAME\", \"S_NATIONKEY\", \"S_PHONE\", \"S_SUPPKEY\", \"PS_PARTKEY\", \"PS_SUPPKEY\", \"PS_SUPPLYCOST\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        }\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"nation\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"nation\"\n"
        + "                        },\n"
        + "                        \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\", \"N_REGIONKEY\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        }\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"part+partsupp+supplier\",\n"
        + "                    \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "                    \"rightAlias\" : \"nation\",\n"
        + "                    \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"part+partsupp+supplier\", \"nation\" ]\n"
        + "                  }\n"
        + "                }\n"
        + "              },\n"
        + "              \"region\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"region\"\n"
        + "                  },\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"selector\",\n"
        + "                    \"dimension\" : \"R_NAME\",\n"
        + "                    \"value\" : \"EUROPE\"\n"
        + "                  },\n"
        + "                  \"columns\" : [ \"R_NAME\", \"R_REGIONKEY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  }\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"part+partsupp+supplier+nation\",\n"
        + "              \"leftJoinColumns\" : [ \"N_REGIONKEY\" ],\n"
        + "              \"rightAlias\" : \"region\",\n"
        + "              \"rightJoinColumns\" : [ \"R_REGIONKEY\" ]\n"
        + "            } ],\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"part+partsupp+supplier+nation\", \"region\" ]\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"part+partsupp+supplier+nation+region\",\n"
        + "        \"leftJoinColumns\" : [ \"PS_SUPPLYCOST\", \"P_PARTKEY\" ],\n"
        + "        \"rightAlias\" : \"part+partsupp+supplier+nation+region$\",\n"
        + "        \"rightJoinColumns\" : [ \"a0\", \"d0\" ]\n"
        + "      } ],\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"part+partsupp+supplier+nation+region\", \"part+partsupp+supplier+nation+region$\" ]\n"
        + "      }\n"
        + "    }\n"
        + "  },\n"
        + "  \"columns\" : [ \"S_ACCTBAL\", \"S_NAME\", \"N_NAME\", \"P_PARTKEY\", \"P_MFGR\", \"S_ADDRESS\", \"S_PHONE\", \"S_COMMENT\" ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"S_ACCTBAL\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"N_NAME\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"S_NAME\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"P_PARTKEY\"\n"
        + "    } ],\n"
        + "    \"limit\" : 100\n"
        + "  }"
        + "}",
        new Object[]{6820.35, "Supplier#000000007", "UNITED KINGDOM", "560", "Manufacturer#2", "s,4TicNGB4uO6PaSqNBUq", "33-990-965-2201", "s unwind silently furiously regular courts. final requests are deposits. requests wake quietly blit"},
        new Object[]{3556.47, "Supplier#000000032", "UNITED KINGDOM", "381", "Manufacturer#5", "yvoD3TtZSx1skQNCK8agk5bZlZLug", "33-484-637-7873", "usly even depths. quickly ironic theodolites s"},
        new Object[]{2972.26, "Supplier#000000016", "RUSSIA", "396", "Manufacturer#3", "YjP5C55zHDXL7LalK27zfQnwejdpin4AMpvh", "32-822-502-4215", "ously express ideas haggle quickly dugouts? fu"}
    );
  }

  @Test
  public void tpch3() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "select\n"
        + "    L_ORDERKEY,\n"
        + "    sum(L_EXTENDEDPRICE * (1 - L_DISCOUNT)) as revenue,\n"
        + "    O_ORDERDATE,\n"
        + "    O_SHIPPRIORITY\n"
        + " from\n"
        + "    customer,\n"
        + "    orders,\n"
        + "    lineitem\n"
        + " where\n"
        + "    C_MKTSEGMENT = 'BUILDING'\n"
        + "    and C_CUSTKEY = O_CUSTKEY\n"
        + "    and L_ORDERKEY = O_ORDERKEY\n"
        + "    and O_ORDERDATE < '1995-03-22'\n"
        + "    and L_SHIPDATE > '1995-03-22'\n"
        + " group by\n"
        + "    L_ORDERKEY,\n"
        + "    O_ORDERDATE,\n"
        + "    O_SHIPPRIORITY\n"
        + " order by\n"
        + "    revenue desc,\n"
        + "    O_ORDERDATE\n"
        + " limit 10",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"customer+orders\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"orders\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"orders\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"bound\",\n"
        + "                    \"dimension\" : \"O_ORDERDATE\",\n"
        + "                    \"upper\" : \"1995-03-22\",\n"
        + "                    \"lowerStrict\" : false,\n"
        + "                    \"upperStrict\" : true,\n"
        + "                    \"comparatorType\" : \"lexicographic\"\n"
        + "                  },\n"
        + "                  \"columns\" : [ \"O_CUSTKEY\", \"O_ORDERDATE\", \"O_ORDERKEY\", \"O_SHIPPRIORITY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              },\n"
        + "              \"customer\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"customer\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"selector\",\n"
        + "                    \"dimension\" : \"C_MKTSEGMENT\",\n"
        + "                    \"value\" : \"BUILDING\"\n"
        + "                  },\n"
        + "                  \"columns\" : [ \"C_CUSTKEY\", \"C_MKTSEGMENT\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"customer\",\n"
        + "              \"leftJoinColumns\" : [ \"C_CUSTKEY\" ],\n"
        + "              \"rightAlias\" : \"orders\",\n"
        + "              \"rightJoinColumns\" : [ \"O_CUSTKEY\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"customer\", \"orders\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"lineitem\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"bound\",\n"
        + "              \"dimension\" : \"L_SHIPDATE\",\n"
        + "              \"lower\" : \"1995-03-22\",\n"
        + "              \"lowerStrict\" : true,\n"
        + "              \"upperStrict\" : false,\n"
        + "              \"comparatorType\" : \"lexicographic\"\n"
        + "            },\n"
        + "            \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_SHIPDATE\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"customer+orders\",\n"
        + "        \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "        \"rightAlias\" : \"lineitem\",\n"
        + "        \"rightJoinColumns\" : [ \"L_ORDERKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"customer+orders\", \"lineitem\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"L_ORDERKEY\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"O_ORDERDATE\",\n"
        + "    \"outputName\" : \"d1\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"O_SHIPPRIORITY\",\n"
        + "    \"outputName\" : \"d2\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"a0\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d1\"\n"
        + "    } ],\n"
        + "    \"limit\" : 10\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"a0\", \"d1\", \"d2\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"26304", 358077.0152279817D, "1995-03-20", 0L},
        new Object[]{"928", 289800.9607996043D, "1995-03-02", 0L},
        new Object[]{"4327", 187634.62862386403D, "1995-03-16", 0L},
        new Object[]{"20453", 176905.6235388234D, "1995-03-11", 0L},
        new Object[]{"20486", 171516.90596939923D, "1995-03-06", 0L},
        new Object[]{"18820", 163812.8043091065D, "1995-02-12", 0L},
        new Object[]{"16096", 147838.6416906625D, "1995-01-20", 0L},
        new Object[]{"3749", 135109.43370970472D, "1995-02-24", 0L},
        new Object[]{"19365", 126378.68876224649D, "1995-01-17", 0L},
        new Object[]{"6560", 123264.19097787395D, "1995-01-05", 0L}
    );
  }

  @Test
  public void tpch4() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "select"
        + " O_ORDERPRIORITY, count(*) as order_count from orders as o"
        + " where O_ORDERDATE >= '1996-05-01' and O_ORDERDATE < '1996-08-01'"
        + "   and exists ( select 1 from lineitem where L_ORDERKEY = o.O_ORDERKEY and L_COMMITDATE < L_RECEIPTDATE)"
        + " group by O_ORDERPRIORITY order by O_ORDERPRIORITY",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"groupBy\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"lineitem\"\n"
        + "            },\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"and\",\n"
        + "              \"fields\" : [ {\n"
        + "                \"type\" : \"math\",\n"
        + "                \"expression\" : \"(\\\"L_COMMITDATE\\\" < \\\"L_RECEIPTDATE\\\")\"\n"
        + "              }, {\n"
        + "                \"type\" : \"not\",\n"
        + "                \"field\" : {\n"
        + "                  \"type\" : \"selector\",\n"
        + "                  \"dimension\" : \"L_ORDERKEY\",\n"
        + "                  \"value\" : \"\"\n"
        + "                }\n"
        + "              } ]\n"
        + "            },\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"dimensions\" : [ {\n"
        + "              \"type\" : \"default\",\n"
        + "              \"dimension\" : \"L_ORDERKEY\",\n"
        + "              \"outputName\" : \"d0\"\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"d0\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"orders\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"orders\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"bound\",\n"
        + "              \"dimension\" : \"O_ORDERDATE\",\n"
        + "              \"lower\" : \"1996-05-01\",\n"
        + "              \"upper\" : \"1996-08-01\",\n"
        + "              \"lowerStrict\" : false,\n"
        + "              \"upperStrict\" : true,\n"
        + "              \"comparatorType\" : \"lexicographic\"\n"
        + "            },\n"
        + "            \"columns\" : [ \"O_ORDERDATE\", \"O_ORDERKEY\", \"O_ORDERPRIORITY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"orders\",\n"
        + "        \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "        \"rightAlias\" : \"lineitem\",\n"
        + "        \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"orders\", \"lineitem\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"O_ORDERPRIORITY\",\n"
        + "    \"outputName\" : \"_d0\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"count\",\n"
        + "    \"name\" : \"a0\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"_d0\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"_d0\", \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"1-URGENT", 53L},
        new Object[]{"2-HIGH", 40L},
        new Object[]{"3-MEDIUM", 50L},
        new Object[]{"4-NOT SPECIFIED", 59L},
        new Object[]{"5-LOW", 53L}
    );
  }

  @Test
  public void tpch5() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "SELECT\n"
        + "    N_NAME,\n"
        + " SUM(L_EXTENDEDPRICE * (1 - L_DISCOUNT)) AS REVENUE\n"
        + " FROM\n"
        + "    customer,\n"
        + "    orders,\n"
        + "    lineitem,\n"
        + "    supplier,\n"
        + "    nation,\n"
        + "    region\n"
        + " WHERE\n"
        + "    C_CUSTKEY = O_CUSTKEY\n"
        + " AND L_ORDERKEY = O_ORDERKEY\n"
        + " AND L_SUPPKEY = S_SUPPKEY\n"
        + " AND C_NATIONKEY = S_NATIONKEY\n"
        + " AND S_NATIONKEY = N_NATIONKEY\n"
        + " AND N_REGIONKEY = R_REGIONKEY\n"
        + " AND R_NAME = 'AFRICA'\n"
        + " AND O_ORDERDATE >= '1993-01-01'\n"
        + " AND O_ORDERDATE < '1994-01-01'\n"
        + " GROUP BY\n"
        + "    N_NAME\n"
        + " ORDER BY\n"
        + "    REVENUE DESC",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"customer+orders+lineitem+supplier+nation\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"nation\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"nation\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\", \"N_REGIONKEY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              },\n"
        + "              \"customer+orders+lineitem+supplier\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"customer+orders+lineitem\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"join\",\n"
        + "                        \"dataSources\" : {\n"
        + "                          \"customer+orders\" : {\n"
        + "                            \"type\" : \"query\",\n"
        + "                            \"query\" : {\n"
        + "                              \"queryType\" : \"join\",\n"
        + "                              \"dataSources\" : {\n"
        + "                                \"orders\" : {\n"
        + "                                  \"type\" : \"query\",\n"
        + "                                  \"query\" : {\n"
        + "                                    \"queryType\" : \"select.stream\",\n"
        + "                                    \"dataSource\" : {\n"
        + "                                      \"type\" : \"table\",\n"
        + "                                      \"name\" : \"orders\"\n"
        + "                                    },\n"
        + "                                    \"descending\" : false,\n"
        + "                                    \"filter\" : {\n"
        + "                                      \"type\" : \"bound\",\n"
        + "                                      \"dimension\" : \"O_ORDERDATE\",\n"
        + "                                      \"lower\" : \"1993-01-01\",\n"
        + "                                      \"upper\" : \"1994-01-01\",\n"
        + "                                      \"lowerStrict\" : false,\n"
        + "                                      \"upperStrict\" : true,\n"
        + "                                      \"comparatorType\" : \"lexicographic\"\n"
        + "                                    },\n"
        + "                                    \"columns\" : [ \"O_CUSTKEY\", \"O_ORDERDATE\", \"O_ORDERKEY\" ],\n"
        + "                                    \"limitSpec\" : {\n"
        + "                                      \"type\" : \"noop\"\n"
        + "                                    },\n"
        + "                                    \"context\" : {\n"
        + "                                      \"groupby.sort.on.time\" : false\n"
        + "                                    }\n"
        + "                                  }\n"
        + "                                },\n"
        + "                                \"customer\" : {\n"
        + "                                  \"type\" : \"query\",\n"
        + "                                  \"query\" : {\n"
        + "                                    \"queryType\" : \"select.stream\",\n"
        + "                                    \"dataSource\" : {\n"
        + "                                      \"type\" : \"table\",\n"
        + "                                      \"name\" : \"customer\"\n"
        + "                                    },\n"
        + "                                    \"descending\" : false,\n"
        + "                                    \"columns\" : [ \"C_CUSTKEY\", \"C_NATIONKEY\" ],\n"
        + "                                    \"limitSpec\" : {\n"
        + "                                      \"type\" : \"noop\"\n"
        + "                                    },\n"
        + "                                    \"context\" : {\n"
        + "                                      \"groupby.sort.on.time\" : false\n"
        + "                                    }\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              },\n"
        + "                              \"elements\" : [ {\n"
        + "                                \"joinType\" : \"INNER\",\n"
        + "                                \"leftAlias\" : \"customer\",\n"
        + "                                \"leftJoinColumns\" : [ \"C_CUSTKEY\" ],\n"
        + "                                \"rightAlias\" : \"orders\",\n"
        + "                                \"rightJoinColumns\" : [ \"O_CUSTKEY\" ]\n"
        + "                              } ],\n"
        + "                              \"prefixAlias\" : false,\n"
        + "                              \"asArray\" : true,\n"
        + "                              \"limit\" : 0,\n"
        + "                              \"context\" : {\n"
        + "                                \"groupby.sort.on.time\" : false\n"
        + "                              },\n"
        + "                              \"dataSource\" : {\n"
        + "                                \"type\" : \"union\",\n"
        + "                                \"dataSources\" : [ \"customer\", \"orders\" ]\n"
        + "                              },\n"
        + "                              \"descending\" : false\n"
        + "                            }\n"
        + "                          },\n"
        + "                          \"lineitem\" : {\n"
        + "                            \"type\" : \"query\",\n"
        + "                            \"query\" : {\n"
        + "                              \"queryType\" : \"select.stream\",\n"
        + "                              \"dataSource\" : {\n"
        + "                                \"type\" : \"table\",\n"
        + "                                \"name\" : \"lineitem\"\n"
        + "                              },\n"
        + "                              \"descending\" : false,\n"
        + "                              \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_SUPPKEY\" ],\n"
        + "                              \"limitSpec\" : {\n"
        + "                                \"type\" : \"noop\"\n"
        + "                              },\n"
        + "                              \"context\" : {\n"
        + "                                \"groupby.sort.on.time\" : false\n"
        + "                              }\n"
        + "                            }\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"elements\" : [ {\n"
        + "                          \"joinType\" : \"INNER\",\n"
        + "                          \"leftAlias\" : \"customer+orders\",\n"
        + "                          \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "                          \"rightAlias\" : \"lineitem\",\n"
        + "                          \"rightJoinColumns\" : [ \"L_ORDERKEY\" ]\n"
        + "                        } ],\n"
        + "                        \"prefixAlias\" : false,\n"
        + "                        \"asArray\" : true,\n"
        + "                        \"limit\" : 0,\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        },\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"union\",\n"
        + "                          \"dataSources\" : [ \"customer+orders\", \"lineitem\" ]\n"
        + "                        },\n"
        + "                        \"descending\" : false\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"supplier\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"supplier\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"customer+orders+lineitem\",\n"
        + "                    \"leftJoinColumns\" : [ \"C_NATIONKEY\", \"L_SUPPKEY\" ],\n"
        + "                    \"rightAlias\" : \"supplier\",\n"
        + "                    \"rightJoinColumns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"prefixAlias\" : false,\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  },\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"customer+orders+lineitem\", \"supplier\" ]\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"customer+orders+lineitem+supplier\",\n"
        + "              \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "              \"rightAlias\" : \"nation\",\n"
        + "              \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"customer+orders+lineitem+supplier\", \"nation\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"region\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"region\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"selector\",\n"
        + "              \"dimension\" : \"R_NAME\",\n"
        + "              \"value\" : \"AFRICA\"\n"
        + "            },\n"
        + "            \"columns\" : [ \"R_NAME\", \"R_REGIONKEY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"customer+orders+lineitem+supplier+nation\",\n"
        + "        \"leftJoinColumns\" : [ \"N_REGIONKEY\" ],\n"
        + "        \"rightAlias\" : \"region\",\n"
        + "        \"rightJoinColumns\" : [ \"R_REGIONKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"customer+orders+lineitem+supplier+nation\", \"region\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"N_NAME\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"a0\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"KENYA", 523154.4750718259D},
        new Object[]{"MOROCCO", 218260.09096727896D},
        new Object[]{"ETHIOPIA", 167163.61263319192D},
        new Object[]{"ALGERIA", 157068.92618799844D},
        new Object[]{"MOZAMBIQUE", 151814.8570359957D}
    );
  }

  @Test
  public void tpch6() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "SELECT\n"
        + " SUM(L_EXTENDEDPRICE * L_DISCOUNT) AS REVENUE\n"
        + " FROM\n"
        + "    lineitem\n"
        + " WHERE\n"
        + "    L_SHIPDATE >= '1993-01-01'\n"
        + " AND L_SHIPDATE < '1994-01-01'\n"
        + " AND L_DISCOUNT BETWEEN 0.06 - 0.01 AND 0.06 + 0.01\n"
        + " AND L_QUANTITY < 25",
        "  {\n"
        + "  \"queryType\" : \"timeseries\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"table\",\n"
        + "    \"name\" : \"lineitem\"\n"
        + "  },\n"
        + "  \"descending\" : false,\n"
        + "  \"filter\" : {\n"
        + "    \"type\" : \"and\",\n"
        + "    \"fields\" : [ {\n"
        + "      \"type\" : \"bound\",\n"
        + "      \"dimension\" : \"L_QUANTITY\",\n"
        + "      \"upper\" : \"25\",\n"
        + "      \"lowerStrict\" : false,\n"
        + "      \"upperStrict\" : true,\n"
        + "      \"comparatorType\" : \"numeric\"\n"
        + "    }, {\n"
        + "      \"type\" : \"bound\",\n"
        + "      \"dimension\" : \"L_DISCOUNT\",\n"
        + "      \"lower\" : \"0.05\",\n"
        + "      \"upper\" : \"0.07\",\n"
        + "      \"lowerStrict\" : false,\n"
        + "      \"upperStrict\" : false,\n"
        + "      \"comparatorType\" : \"numeric\"\n"
        + "    }, {\n"
        + "      \"type\" : \"bound\",\n"
        + "      \"dimension\" : \"L_SHIPDATE\",\n"
        + "      \"lower\" : \"1993-01-01\",\n"
        + "      \"upper\" : \"1994-01-01\",\n"
        + "      \"lowerStrict\" : false,\n"
        + "      \"upperStrict\" : true,\n"
        + "      \"comparatorType\" : \"lexicographic\"\n"
        + "    } ]\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * \\\"L_DISCOUNT\\\")\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"noop\"\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  }\n"
        + "}",
        new Object[]{635343.2898368868}
    );
  }

  @Test
  public void tpch7() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "SELECT\n"
        + "    SUPP_NATION,\n"
        + "    CUST_NATION,\n"
        + "    L_YEAR,\n"
        + "    SUM(VOLUME) AS REVENUE\n"
        + " FROM\n"
        + "    (\n"
        + "        SELECT\n"
        + "            N1.N_NAME AS SUPP_NATION,\n"
        + "            N2.N_NAME AS CUST_NATION,\n"
        + "            YEAR(L_SHIPDATE) AS L_YEAR,\n"
        + "            L_EXTENDEDPRICE * (1 - L_DISCOUNT) AS VOLUME\n"
        + "        FROM\n"
        + "            supplier,\n"
        + "            lineitem,\n"
        + "            orders,\n"
        + "            customer,\n"
        + "            nation N1,\n"
        + "            nation N2\n"
        + "        WHERE\n"
        + "            S_SUPPKEY = L_SUPPKEY\n"
        + "            AND O_ORDERKEY = L_ORDERKEY\n"
        + "            AND C_CUSTKEY = O_CUSTKEY\n"
        + "            AND S_NATIONKEY = N1.N_NATIONKEY\n"
        + "            AND C_NATIONKEY = N2.N_NATIONKEY\n"
        + "            AND (\n"
        + "                (N1.N_NAME = 'KENYA' AND N2.N_NAME = 'PERU')\n"
        + "                OR (N1.N_NAME = 'PERU' AND N2.N_NAME = 'KENYA')\n"
        + "            )\n"
        + "            AND L_SHIPDATE BETWEEN '1995-01-01' AND '1996-12-31'\n"
        + "    ) AS SHIPPING\n"
        + " GROUP BY\n"
        + "    SUPP_NATION,\n"
        + "    CUST_NATION,\n"
        + "    L_YEAR\n"
        + " ORDER BY\n"
        + "    SUPP_NATION,\n"
        + "    CUST_NATION,\n"
        + "    L_YEAR",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"nation\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"nation\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"nation+supplier+lineitem+orders+customer\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"nation\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"nation\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              },\n"
        + "              \"supplier+lineitem+orders+customer\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"supplier+lineitem+orders\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"join\",\n"
        + "                        \"dataSources\" : {\n"
        + "                          \"supplier+lineitem\" : {\n"
        + "                            \"type\" : \"query\",\n"
        + "                            \"query\" : {\n"
        + "                              \"queryType\" : \"join\",\n"
        + "                              \"dataSources\" : {\n"
        + "                                \"lineitem\" : {\n"
        + "                                  \"type\" : \"query\",\n"
        + "                                  \"query\" : {\n"
        + "                                    \"queryType\" : \"select.stream\",\n"
        + "                                    \"dataSource\" : {\n"
        + "                                      \"type\" : \"table\",\n"
        + "                                      \"name\" : \"lineitem\"\n"
        + "                                    },\n"
        + "                                    \"descending\" : false,\n"
        + "                                    \"filter\" : {\n"
        + "                                      \"type\" : \"bound\",\n"
        + "                                      \"dimension\" : \"L_SHIPDATE\",\n"
        + "                                      \"lower\" : \"1995-01-01\",\n"
        + "                                      \"upper\" : \"1996-12-31\",\n"
        + "                                      \"lowerStrict\" : false,\n"
        + "                                      \"upperStrict\" : false,\n"
        + "                                      \"comparatorType\" : \"lexicographic\"\n"
        + "                                    },\n"
        + "                                    \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_SHIPDATE\", \"L_SUPPKEY\" ],\n"
        + "                                    \"limitSpec\" : {\n"
        + "                                      \"type\" : \"noop\"\n"
        + "                                    },\n"
        + "                                    \"context\" : {\n"
        + "                                      \"groupby.sort.on.time\" : false\n"
        + "                                    }\n"
        + "                                  }\n"
        + "                                },\n"
        + "                                \"supplier\" : {\n"
        + "                                  \"type\" : \"query\",\n"
        + "                                  \"query\" : {\n"
        + "                                    \"queryType\" : \"select.stream\",\n"
        + "                                    \"dataSource\" : {\n"
        + "                                      \"type\" : \"table\",\n"
        + "                                      \"name\" : \"supplier\"\n"
        + "                                    },\n"
        + "                                    \"descending\" : false,\n"
        + "                                    \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                                    \"limitSpec\" : {\n"
        + "                                      \"type\" : \"noop\"\n"
        + "                                    },\n"
        + "                                    \"context\" : {\n"
        + "                                      \"groupby.sort.on.time\" : false\n"
        + "                                    }\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              },\n"
        + "                              \"elements\" : [ {\n"
        + "                                \"joinType\" : \"INNER\",\n"
        + "                                \"leftAlias\" : \"supplier\",\n"
        + "                                \"leftJoinColumns\" : [ \"S_SUPPKEY\" ],\n"
        + "                                \"rightAlias\" : \"lineitem\",\n"
        + "                                \"rightJoinColumns\" : [ \"L_SUPPKEY\" ]\n"
        + "                              } ],\n"
        + "                              \"prefixAlias\" : false,\n"
        + "                              \"asArray\" : true,\n"
        + "                              \"limit\" : 0,\n"
        + "                              \"context\" : {\n"
        + "                                \"groupby.sort.on.time\" : false\n"
        + "                              },\n"
        + "                              \"dataSource\" : {\n"
        + "                                \"type\" : \"union\",\n"
        + "                                \"dataSources\" : [ \"supplier\", \"lineitem\" ]\n"
        + "                              },\n"
        + "                              \"descending\" : false\n"
        + "                            }\n"
        + "                          },\n"
        + "                          \"orders\" : {\n"
        + "                            \"type\" : \"query\",\n"
        + "                            \"query\" : {\n"
        + "                              \"queryType\" : \"select.stream\",\n"
        + "                              \"dataSource\" : {\n"
        + "                                \"type\" : \"table\",\n"
        + "                                \"name\" : \"orders\"\n"
        + "                              },\n"
        + "                              \"descending\" : false,\n"
        + "                              \"columns\" : [ \"O_CUSTKEY\", \"O_ORDERKEY\" ],\n"
        + "                              \"limitSpec\" : {\n"
        + "                                \"type\" : \"noop\"\n"
        + "                              },\n"
        + "                              \"context\" : {\n"
        + "                                \"groupby.sort.on.time\" : false\n"
        + "                              }\n"
        + "                            }\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"elements\" : [ {\n"
        + "                          \"joinType\" : \"INNER\",\n"
        + "                          \"leftAlias\" : \"supplier+lineitem\",\n"
        + "                          \"leftJoinColumns\" : [ \"L_ORDERKEY\" ],\n"
        + "                          \"rightAlias\" : \"orders\",\n"
        + "                          \"rightJoinColumns\" : [ \"O_ORDERKEY\" ]\n"
        + "                        } ],\n"
        + "                        \"prefixAlias\" : false,\n"
        + "                        \"asArray\" : true,\n"
        + "                        \"limit\" : 0,\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        },\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"union\",\n"
        + "                          \"dataSources\" : [ \"supplier+lineitem\", \"orders\" ]\n"
        + "                        },\n"
        + "                        \"descending\" : false\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"customer\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"customer\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"C_CUSTKEY\", \"C_NATIONKEY\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"supplier+lineitem+orders\",\n"
        + "                    \"leftJoinColumns\" : [ \"O_CUSTKEY\" ],\n"
        + "                    \"rightAlias\" : \"customer\",\n"
        + "                    \"rightJoinColumns\" : [ \"C_CUSTKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"prefixAlias\" : false,\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  },\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"supplier+lineitem+orders\", \"customer\" ]\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"nation\",\n"
        + "              \"leftJoinColumns\" : [ \"N_NATIONKEY\" ],\n"
        + "              \"rightAlias\" : \"supplier+lineitem+orders+customer\",\n"
        + "              \"rightJoinColumns\" : [ \"C_NATIONKEY\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"nation\", \"supplier+lineitem+orders+customer\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"nation+supplier+lineitem+orders+customer\",\n"
        + "        \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "        \"rightAlias\" : \"nation\",\n"
        + "        \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"nation+supplier+lineitem+orders+customer\", \"nation\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"filter\" : {\n"
        + "    \"type\" : \"or\",\n"
        + "    \"fields\" : [ {\n"
        + "      \"type\" : \"and\",\n"
        + "      \"fields\" : [ {\n"
        + "        \"type\" : \"selector\",\n"
        + "        \"dimension\" : \"N_NAME0\",\n"
        + "        \"value\" : \"KENYA\"\n"
        + "      }, {\n"
        + "        \"type\" : \"selector\",\n"
        + "        \"dimension\" : \"N_NAME\",\n"
        + "        \"value\" : \"PERU\"\n"
        + "      } ]\n"
        + "    }, {\n"
        + "      \"type\" : \"and\",\n"
        + "      \"fields\" : [ {\n"
        + "        \"type\" : \"selector\",\n"
        + "        \"dimension\" : \"N_NAME0\",\n"
        + "        \"value\" : \"PERU\"\n"
        + "      }, {\n"
        + "        \"type\" : \"selector\",\n"
        + "        \"dimension\" : \"N_NAME\",\n"
        + "        \"value\" : \"KENYA\"\n"
        + "      } ]\n"
        + "    } ]\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"N_NAME0\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"N_NAME\",\n"
        + "    \"outputName\" : \"d1\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"d2:v\",\n"
        + "    \"outputName\" : \"d2\"\n"
        + "  } ],\n"
        + "  \"virtualColumns\" : [ {\n"
        + "    \"type\" : \"expr\",\n"
        + "    \"expression\" : \"YEAR(\\\"L_SHIPDATE\\\")\",\n"
        + "    \"outputName\" : \"d2:v\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d0\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d1\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d2\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"d1\", \"d2\", \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"KENYA", "PERU", 1995L, 155808.41736393946D},
        new Object[]{"KENYA", "PERU", 1996L, 335577.4810472458D},
        new Object[]{"PERU", "KENYA", 1995L, 243818.19482950834D},
        new Object[]{"PERU", "KENYA", 1996L, 105976.76512348771D}
    );
  }

  @Test
  public void tpch8() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "SELECT\n"
        + "    O_YEAR,\n"
        + " SUM(CASE\n"
        + "        WHEN NATION = 'PERU' THEN VOLUME\n"
        + "        ELSE 0\n"
        + "    END) / SUM(VOLUME) AS MKT_SHARE\n"
        + " FROM\n"
        + "    (\n"
        + " SELECT\n"
        + "            YEAR(O_ORDERDATE) AS O_YEAR,\n"
        + "            L_EXTENDEDPRICE * (1 - L_DISCOUNT) AS VOLUME,\n"
        + " N2.N_NAME AS NATION\n"
        + " FROM\n"
        + "            part,\n"
        + "            supplier,\n"
        + "            lineitem,\n"
        + "            orders,\n"
        + "            customer,\n"
        + "            nation N1,\n"
        + "            nation N2,\n"
        + "            region\n"
        + " WHERE\n"
        + "            P_PARTKEY = L_PARTKEY\n"
        + " AND S_SUPPKEY = L_SUPPKEY\n"
        + " AND L_ORDERKEY = O_ORDERKEY\n"
        + " AND O_CUSTKEY = C_CUSTKEY\n"
        + " AND C_NATIONKEY = N1.N_NATIONKEY\n"
        + " AND N1.N_REGIONKEY = R_REGIONKEY\n"
        + " AND R_NAME = 'AMERICA'\n"
        + " AND S_NATIONKEY = N2.N_NATIONKEY\n"
        + " AND O_ORDERDATE BETWEEN '1995-01-01' AND '1996-12-31'\n"
        + " AND P_TYPE = 'ECONOMY BURNISHED NICKEL'\n"
        + "    ) AS ALL_NATIONS\n"
        + " GROUP BY\n"
        + "    O_YEAR\n"
        + " ORDER BY\n"
        + "    O_YEAR",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"part+lineitem+supplier+orders+customer+nation+nation\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"part+lineitem+supplier+orders+customer+nation\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"nation\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"nation\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"N_NATIONKEY\", \"N_REGIONKEY\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"part+lineitem+supplier+orders+customer\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"join\",\n"
        + "                        \"dataSources\" : {\n"
        + "                          \"part+lineitem+supplier+orders\" : {\n"
        + "                            \"type\" : \"query\",\n"
        + "                            \"query\" : {\n"
        + "                              \"queryType\" : \"join\",\n"
        + "                              \"dataSources\" : {\n"
        + "                                \"part+lineitem+supplier\" : {\n"
        + "                                  \"type\" : \"query\",\n"
        + "                                  \"query\" : {\n"
        + "                                    \"queryType\" : \"select.stream\",\n"
        + "                                    \"dataSource\" : {\n"
        + "                                      \"type\" : \"query\",\n"
        + "                                      \"query\" : {\n"
        + "                                        \"queryType\" : \"join\",\n"
        + "                                        \"dataSources\" : {\n"
        + "                                          \"supplier\" : {\n"
        + "                                            \"type\" : \"query\",\n"
        + "                                            \"query\" : {\n"
        + "                                              \"queryType\" : \"select.stream\",\n"
        + "                                              \"dataSource\" : {\n"
        + "                                                \"type\" : \"table\",\n"
        + "                                                \"name\" : \"supplier\"\n"
        + "                                              },\n"
        + "                                              \"descending\" : false,\n"
        + "                                              \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                                              \"limitSpec\" : {\n"
        + "                                                \"type\" : \"noop\"\n"
        + "                                              },\n"
        + "                                              \"context\" : {\n"
        + "                                                \"groupby.sort.on.time\" : false\n"
        + "                                              }\n"
        + "                                            }\n"
        + "                                          },\n"
        + "                                          \"part+lineitem\" : {\n"
        + "                                            \"type\" : \"query\",\n"
        + "                                            \"query\" : {\n"
        + "                                              \"queryType\" : \"join\",\n"
        + "                                              \"dataSources\" : {\n"
        + "                                                \"lineitem\" : {\n"
        + "                                                  \"type\" : \"query\",\n"
        + "                                                  \"query\" : {\n"
        + "                                                    \"queryType\" : \"select.stream\",\n"
        + "                                                    \"dataSource\" : {\n"
        + "                                                      \"type\" : \"table\",\n"
        + "                                                      \"name\" : \"lineitem\"\n"
        + "                                                    },\n"
        + "                                                    \"descending\" : false,\n"
        + "                                                    \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_PARTKEY\", \"L_SUPPKEY\" ],\n"
        + "                                                    \"limitSpec\" : {\n"
        + "                                                      \"type\" : \"noop\"\n"
        + "                                                    },\n"
        + "                                                    \"context\" : {\n"
        + "                                                      \"groupby.sort.on.time\" : false\n"
        + "                                                    }\n"
        + "                                                  }\n"
        + "                                                },\n"
        + "                                                \"part\" : {\n"
        + "                                                  \"type\" : \"query\",\n"
        + "                                                  \"query\" : {\n"
        + "                                                    \"queryType\" : \"select.stream\",\n"
        + "                                                    \"dataSource\" : {\n"
        + "                                                      \"type\" : \"table\",\n"
        + "                                                      \"name\" : \"part\"\n"
        + "                                                    },\n"
        + "                                                    \"descending\" : false,\n"
        + "                                                    \"filter\" : {\n"
        + "                                                      \"type\" : \"selector\",\n"
        + "                                                      \"dimension\" : \"P_TYPE\",\n"
        + "                                                      \"value\" : \"ECONOMY BURNISHED NICKEL\"\n"
        + "                                                    },\n"
        + "                                                    \"columns\" : [ \"P_PARTKEY\", \"P_TYPE\" ],\n"
        + "                                                    \"limitSpec\" : {\n"
        + "                                                      \"type\" : \"noop\"\n"
        + "                                                    },\n"
        + "                                                    \"context\" : {\n"
        + "                                                      \"groupby.sort.on.time\" : false\n"
        + "                                                    }\n"
        + "                                                  }\n"
        + "                                                }\n"
        + "                                              },\n"
        + "                                              \"elements\" : [ {\n"
        + "                                                \"joinType\" : \"INNER\",\n"
        + "                                                \"leftAlias\" : \"part\",\n"
        + "                                                \"leftJoinColumns\" : [ \"P_PARTKEY\" ],\n"
        + "                                                \"rightAlias\" : \"lineitem\",\n"
        + "                                                \"rightJoinColumns\" : [ \"L_PARTKEY\" ]\n"
        + "                                              } ],\n"
        + "                                              \"prefixAlias\" : false,\n"
        + "                                              \"asArray\" : true,\n"
        + "                                              \"limit\" : 0,\n"
        + "                                              \"context\" : {\n"
        + "                                                \"groupby.sort.on.time\" : false\n"
        + "                                              },\n"
        + "                                              \"dataSource\" : {\n"
        + "                                                \"type\" : \"union\",\n"
        + "                                                \"dataSources\" : [ \"part\", \"lineitem\" ]\n"
        + "                                              },\n"
        + "                                              \"descending\" : false\n"
        + "                                            }\n"
        + "                                          }\n"
        + "                                        },\n"
        + "                                        \"elements\" : [ {\n"
        + "                                          \"joinType\" : \"INNER\",\n"
        + "                                          \"leftAlias\" : \"part+lineitem\",\n"
        + "                                          \"leftJoinColumns\" : [ \"L_SUPPKEY\" ],\n"
        + "                                          \"rightAlias\" : \"supplier\",\n"
        + "                                          \"rightJoinColumns\" : [ \"S_SUPPKEY\" ]\n"
        + "                                        } ],\n"
        + "                                        \"prefixAlias\" : false,\n"
        + "                                        \"asArray\" : true,\n"
        + "                                        \"limit\" : 0,\n"
        + "                                        \"context\" : {\n"
        + "                                          \"groupby.sort.on.time\" : false\n"
        + "                                        },\n"
        + "                                        \"dataSource\" : {\n"
        + "                                          \"type\" : \"union\",\n"
        + "                                          \"dataSources\" : [ \"part+lineitem\", \"supplier\" ]\n"
        + "                                        },\n"
        + "                                        \"descending\" : false\n"
        + "                                      }\n"
        + "                                    },\n"
        + "                                    \"descending\" : false,\n"
        + "                                    \"columns\" : [ \"P_PARTKEY\", \"P_TYPE\", \"S_NATIONKEY\", \"S_SUPPKEY\", \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_PARTKEY\", \"L_SUPPKEY\" ],\n"
        + "                                    \"limitSpec\" : {\n"
        + "                                      \"type\" : \"noop\"\n"
        + "                                    },\n"
        + "                                    \"context\" : {\n"
        + "                                      \"groupby.sort.on.time\" : false\n"
        + "                                    }\n"
        + "                                  }\n"
        + "                                },\n"
        + "                                \"orders\" : {\n"
        + "                                  \"type\" : \"query\",\n"
        + "                                  \"query\" : {\n"
        + "                                    \"queryType\" : \"select.stream\",\n"
        + "                                    \"dataSource\" : {\n"
        + "                                      \"type\" : \"table\",\n"
        + "                                      \"name\" : \"orders\"\n"
        + "                                    },\n"
        + "                                    \"descending\" : false,\n"
        + "                                    \"filter\" : {\n"
        + "                                      \"type\" : \"bound\",\n"
        + "                                      \"dimension\" : \"O_ORDERDATE\",\n"
        + "                                      \"lower\" : \"1995-01-01\",\n"
        + "                                      \"upper\" : \"1996-12-31\",\n"
        + "                                      \"lowerStrict\" : false,\n"
        + "                                      \"upperStrict\" : false,\n"
        + "                                      \"comparatorType\" : \"lexicographic\"\n"
        + "                                    },\n"
        + "                                    \"columns\" : [ \"O_CUSTKEY\", \"O_ORDERDATE\", \"O_ORDERKEY\" ],\n"
        + "                                    \"limitSpec\" : {\n"
        + "                                      \"type\" : \"noop\"\n"
        + "                                    },\n"
        + "                                    \"context\" : {\n"
        + "                                      \"groupby.sort.on.time\" : false\n"
        + "                                    }\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              },\n"
        + "                              \"elements\" : [ {\n"
        + "                                \"joinType\" : \"INNER\",\n"
        + "                                \"leftAlias\" : \"part+lineitem+supplier\",\n"
        + "                                \"leftJoinColumns\" : [ \"L_ORDERKEY\" ],\n"
        + "                                \"rightAlias\" : \"orders\",\n"
        + "                                \"rightJoinColumns\" : [ \"O_ORDERKEY\" ]\n"
        + "                              } ],\n"
        + "                              \"prefixAlias\" : false,\n"
        + "                              \"asArray\" : true,\n"
        + "                              \"limit\" : 0,\n"
        + "                              \"context\" : {\n"
        + "                                \"groupby.sort.on.time\" : false\n"
        + "                              },\n"
        + "                              \"dataSource\" : {\n"
        + "                                \"type\" : \"union\",\n"
        + "                                \"dataSources\" : [ \"part+lineitem+supplier\", \"orders\" ]\n"
        + "                              },\n"
        + "                              \"descending\" : false\n"
        + "                            }\n"
        + "                          },\n"
        + "                          \"customer\" : {\n"
        + "                            \"type\" : \"query\",\n"
        + "                            \"query\" : {\n"
        + "                              \"queryType\" : \"select.stream\",\n"
        + "                              \"dataSource\" : {\n"
        + "                                \"type\" : \"table\",\n"
        + "                                \"name\" : \"customer\"\n"
        + "                              },\n"
        + "                              \"descending\" : false,\n"
        + "                              \"columns\" : [ \"C_CUSTKEY\", \"C_NATIONKEY\" ],\n"
        + "                              \"limitSpec\" : {\n"
        + "                                \"type\" : \"noop\"\n"
        + "                              },\n"
        + "                              \"context\" : {\n"
        + "                                \"groupby.sort.on.time\" : false\n"
        + "                              }\n"
        + "                            }\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"elements\" : [ {\n"
        + "                          \"joinType\" : \"INNER\",\n"
        + "                          \"leftAlias\" : \"part+lineitem+supplier+orders\",\n"
        + "                          \"leftJoinColumns\" : [ \"O_CUSTKEY\" ],\n"
        + "                          \"rightAlias\" : \"customer\",\n"
        + "                          \"rightJoinColumns\" : [ \"C_CUSTKEY\" ]\n"
        + "                        } ],\n"
        + "                        \"prefixAlias\" : false,\n"
        + "                        \"asArray\" : true,\n"
        + "                        \"limit\" : 0,\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        },\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"union\",\n"
        + "                          \"dataSources\" : [ \"part+lineitem+supplier+orders\", \"customer\" ]\n"
        + "                        },\n"
        + "                        \"descending\" : false\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"part+lineitem+supplier+orders+customer\",\n"
        + "                    \"leftJoinColumns\" : [ \"C_NATIONKEY\" ],\n"
        + "                    \"rightAlias\" : \"nation\",\n"
        + "                    \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"prefixAlias\" : false,\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  },\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"part+lineitem+supplier+orders+customer\", \"nation\" ]\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              },\n"
        + "              \"nation\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"nation\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"part+lineitem+supplier+orders+customer+nation\",\n"
        + "              \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "              \"rightAlias\" : \"nation\",\n"
        + "              \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"part+lineitem+supplier+orders+customer+nation\", \"nation\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"region\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"region\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"selector\",\n"
        + "              \"dimension\" : \"R_NAME\",\n"
        + "              \"value\" : \"AMERICA\"\n"
        + "            },\n"
        + "            \"columns\" : [ \"R_NAME\", \"R_REGIONKEY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"part+lineitem+supplier+orders+customer+nation+nation\",\n"
        + "        \"leftJoinColumns\" : [ \"N_REGIONKEY\" ],\n"
        + "        \"rightAlias\" : \"region\",\n"
        + "        \"rightJoinColumns\" : [ \"R_REGIONKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"part+lineitem+supplier+orders+customer+nation+nation\", \"region\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"d0:v\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  } ],\n"
        + "  \"virtualColumns\" : [ {\n"
        + "    \"type\" : \"expr\",\n"
        + "    \"expression\" : \"YEAR(\\\"O_ORDERDATE\\\")\",\n"
        + "    \"outputName\" : \"d0:v\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"case((\\\"N_NAME\\\" == 'PERU'),(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\")),0)\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  }, {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a1\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"postAggregations\" : [ {\n"
        + "    \"type\" : \"math\",\n"
        + "    \"name\" : \"s0\",\n"
        + "    \"expression\" : \"(\\\"a0\\\" / \\\"a1\\\")\",\n"
        + "    \"finalize\" : true\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d0\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"s0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{1995L, 0.0D},
        new Object[]{1996L, 0.0D}
    );
  }

  @Test
  public void tpch9() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "SELECT\n"
        + "    NATION,\n"
        + "    O_YEAR,\n"
        + "    SUM(AMOUNT) AS SUM_PROFIT\n"
        + " FROM\n"
        + "    (\n"
        + "        SELECT\n"
        + "            N_NAME AS NATION,\n"
        + "            YEAR(O_ORDERDATE) AS O_YEAR,\n"
        + "            L_EXTENDEDPRICE * (1 - L_DISCOUNT) - PS_SUPPLYCOST * L_QUANTITY AS AMOUNT\n"
        + "        FROM\n"
        + "            part,\n"
        + "            supplier,\n"
        + "            lineitem,\n"
        + "            partsupp,\n"
        + "            orders,\n"
        + "            nation\n"
        + "        WHERE\n"
        + "            S_SUPPKEY = L_SUPPKEY\n"
        + "            AND PS_SUPPKEY = L_SUPPKEY\n"
        + "            AND PS_PARTKEY = L_PARTKEY\n"
        + "            AND P_PARTKEY = L_PARTKEY\n"
        + "            AND O_ORDERKEY = L_ORDERKEY\n"
        + "            AND S_NATIONKEY = N_NATIONKEY\n"
        + "            AND P_NAME LIKE '%plum%'\n"
        + "    ) AS PROFIT\n"
        + " GROUP BY\n"
        + "    NATION,\n"
        + "    O_YEAR\n"
        + " ORDER BY\n"
        + "    NATION,\n"
        + "    O_YEAR DESC",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"nation\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"nation\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"part+lineitem+supplier+partsupp+orders\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"part+lineitem+supplier+partsupp\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"part+lineitem+supplier\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"join\",\n"
        + "                            \"dataSources\" : {\n"
        + "                              \"supplier\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"select.stream\",\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"table\",\n"
        + "                                    \"name\" : \"supplier\"\n"
        + "                                  },\n"
        + "                                  \"descending\" : false,\n"
        + "                                  \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                                  \"limitSpec\" : {\n"
        + "                                    \"type\" : \"noop\"\n"
        + "                                  },\n"
        + "                                  \"context\" : {\n"
        + "                                    \"groupby.sort.on.time\" : false\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              },\n"
        + "                              \"part+lineitem\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"join\",\n"
        + "                                  \"dataSources\" : {\n"
        + "                                    \"lineitem\" : {\n"
        + "                                      \"type\" : \"query\",\n"
        + "                                      \"query\" : {\n"
        + "                                        \"queryType\" : \"select.stream\",\n"
        + "                                        \"dataSource\" : {\n"
        + "                                          \"type\" : \"table\",\n"
        + "                                          \"name\" : \"lineitem\"\n"
        + "                                        },\n"
        + "                                        \"descending\" : false,\n"
        + "                                        \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_PARTKEY\", \"L_QUANTITY\", \"L_SUPPKEY\" ],\n"
        + "                                        \"limitSpec\" : {\n"
        + "                                          \"type\" : \"noop\"\n"
        + "                                        },\n"
        + "                                        \"context\" : {\n"
        + "                                          \"groupby.sort.on.time\" : false\n"
        + "                                        }\n"
        + "                                      }\n"
        + "                                    },\n"
        + "                                    \"part\" : {\n"
        + "                                      \"type\" : \"query\",\n"
        + "                                      \"query\" : {\n"
        + "                                        \"queryType\" : \"select.stream\",\n"
        + "                                        \"dataSource\" : {\n"
        + "                                          \"type\" : \"table\",\n"
        + "                                          \"name\" : \"part\"\n"
        + "                                        },\n"
        + "                                        \"descending\" : false,\n"
        + "                                        \"filter\" : {\n"
        + "                                          \"type\" : \"like\",\n"
        + "                                          \"dimension\" : \"P_NAME\",\n"
        + "                                          \"pattern\" : \"%plum%\"\n"
        + "                                        },\n"
        + "                                        \"columns\" : [ \"P_NAME\", \"P_PARTKEY\" ],\n"
        + "                                        \"limitSpec\" : {\n"
        + "                                          \"type\" : \"noop\"\n"
        + "                                        },\n"
        + "                                        \"context\" : {\n"
        + "                                          \"groupby.sort.on.time\" : false\n"
        + "                                        }\n"
        + "                                      }\n"
        + "                                    }\n"
        + "                                  },\n"
        + "                                  \"elements\" : [ {\n"
        + "                                    \"joinType\" : \"INNER\",\n"
        + "                                    \"leftAlias\" : \"part\",\n"
        + "                                    \"leftJoinColumns\" : [ \"P_PARTKEY\" ],\n"
        + "                                    \"rightAlias\" : \"lineitem\",\n"
        + "                                    \"rightJoinColumns\" : [ \"L_PARTKEY\" ]\n"
        + "                                  } ],\n"
        + "                                  \"prefixAlias\" : false,\n"
        + "                                  \"asArray\" : true,\n"
        + "                                  \"limit\" : 0,\n"
        + "                                  \"context\" : {\n"
        + "                                    \"groupby.sort.on.time\" : false\n"
        + "                                  },\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"union\",\n"
        + "                                    \"dataSources\" : [ \"part\", \"lineitem\" ]\n"
        + "                                  },\n"
        + "                                  \"descending\" : false\n"
        + "                                }\n"
        + "                              }\n"
        + "                            },\n"
        + "                            \"elements\" : [ {\n"
        + "                              \"joinType\" : \"INNER\",\n"
        + "                              \"leftAlias\" : \"part+lineitem\",\n"
        + "                              \"leftJoinColumns\" : [ \"L_SUPPKEY\" ],\n"
        + "                              \"rightAlias\" : \"supplier\",\n"
        + "                              \"rightJoinColumns\" : [ \"S_SUPPKEY\" ]\n"
        + "                            } ],\n"
        + "                            \"prefixAlias\" : false,\n"
        + "                            \"asArray\" : true,\n"
        + "                            \"limit\" : 0,\n"
        + "                            \"context\" : {\n"
        + "                              \"groupby.sort.on.time\" : false\n"
        + "                            },\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"union\",\n"
        + "                              \"dataSources\" : [ \"part+lineitem\", \"supplier\" ]\n"
        + "                            },\n"
        + "                            \"descending\" : false\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"P_NAME\", \"P_PARTKEY\", \"S_NATIONKEY\", \"S_SUPPKEY\", \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_PARTKEY\", \"L_QUANTITY\", \"L_SUPPKEY\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"partsupp\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"partsupp\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"PS_PARTKEY\", \"PS_SUPPKEY\", \"PS_SUPPLYCOST\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"part+lineitem+supplier\",\n"
        + "                    \"leftJoinColumns\" : [ \"L_SUPPKEY\", \"L_PARTKEY\" ],\n"
        + "                    \"rightAlias\" : \"partsupp\",\n"
        + "                    \"rightJoinColumns\" : [ \"PS_SUPPKEY\", \"PS_PARTKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"prefixAlias\" : false,\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  },\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"part+lineitem+supplier\", \"partsupp\" ]\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              },\n"
        + "              \"orders\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"orders\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"columns\" : [ \"O_ORDERDATE\", \"O_ORDERKEY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"part+lineitem+supplier+partsupp\",\n"
        + "              \"leftJoinColumns\" : [ \"L_ORDERKEY\" ],\n"
        + "              \"rightAlias\" : \"orders\",\n"
        + "              \"rightJoinColumns\" : [ \"O_ORDERKEY\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"part+lineitem+supplier+partsupp\", \"orders\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"part+lineitem+supplier+partsupp+orders\",\n"
        + "        \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "        \"rightAlias\" : \"nation\",\n"
        + "        \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"part+lineitem+supplier+partsupp+orders\", \"nation\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"N_NAME\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"d1:v\",\n"
        + "    \"outputName\" : \"d1\"\n"
        + "  } ],\n"
        + "  \"virtualColumns\" : [ {\n"
        + "    \"type\" : \"expr\",\n"
        + "    \"expression\" : \"YEAR(\\\"O_ORDERDATE\\\")\",\n"
        + "    \"outputName\" : \"d1:v\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"((\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\")) - (\\\"PS_SUPPLYCOST\\\" * \\\"L_QUANTITY\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d0\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"d1\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"d1\", \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"ALGERIA", 1998L, 114041.26288207975D},
        new Object[]{"ALGERIA", 1997L, 420005.5203654439D},
        new Object[]{"ALGERIA", 1996L, 179435.92888346483D},
        new Object[]{"ALGERIA", 1995L, 582584.3183930825D},
        new Object[]{"ALGERIA", 1994L, 460802.84925473155D},
        new Object[]{"ALGERIA", 1993L, 358757.83164962556D},
        new Object[]{"ALGERIA", 1992L, 196711.9832104973D},
        new Object[]{"ARGENTINA", 1998L, 108010.48797064778D},
        new Object[]{"ARGENTINA", 1997L, 38692.829331616085D},
        new Object[]{"ARGENTINA", 1996L, 56161.95963088006D},
        new Object[]{"ARGENTINA", 1995L, 206313.3982588728D},
        new Object[]{"ARGENTINA", 1994L, 138654.5828448139D},
        new Object[]{"ARGENTINA", 1993L, 130070.15644093126D},
        new Object[]{"ARGENTINA", 1992L, 249187.6225541356D},
        new Object[]{"BRAZIL", 1997L, 275368.15491910925D},
        new Object[]{"BRAZIL", 1996L, 121697.6010062104D},
        new Object[]{"BRAZIL", 1995L, 180382.19198142894D},
        new Object[]{"BRAZIL", 1994L, 135981.81329815474D},
        new Object[]{"BRAZIL", 1993L, 92990.53442113772D},
        new Object[]{"BRAZIL", 1992L, 132591.4652138137D},
        new Object[]{"CANADA", 1998L, 203860.59596039646D},
        new Object[]{"CANADA", 1997L, 321769.0730324794D},
        new Object[]{"CANADA", 1996L, 171418.1153069712D},
        new Object[]{"CANADA", 1995L, 335742.0634719974D},
        new Object[]{"CANADA", 1994L, 111252.62846753643D},
        new Object[]{"CANADA", 1993L, 195046.8248396663D},
        new Object[]{"CANADA", 1992L, 290137.69375805295D},
        new Object[]{"CHINA", 1998L, 172477.83204571763D},
        new Object[]{"CHINA", 1997L, 275949.41903671867D},
        new Object[]{"CHINA", 1996L, 262160.86886519537D},
        new Object[]{"CHINA", 1995L, 311497.5085121061D},
        new Object[]{"CHINA", 1994L, 163460.95307904793D},
        new Object[]{"CHINA", 1993L, 180435.7027487494D},
        new Object[]{"CHINA", 1992L, 330379.5508661473D},
        new Object[]{"EGYPT", 1998L, 21087.458950298802D},
        new Object[]{"EGYPT", 1997L, 103924.7150228204D},
        new Object[]{"EGYPT", 1996L, 100910.742700351D},
        new Object[]{"EGYPT", 1995L, 79938.60535488653D},
        new Object[]{"EGYPT", 1994L, 187349.3030446754D},
        new Object[]{"EGYPT", 1993L, 330374.52637260495D},
        new Object[]{"EGYPT", 1992L, 280424.466604101D},
        new Object[]{"ETHIOPIA", 1998L, 194613.5621839631D},
        new Object[]{"ETHIOPIA", 1997L, 220107.25268530956D},
        new Object[]{"ETHIOPIA", 1996L, 158622.32201870752D},
        new Object[]{"ETHIOPIA", 1995L, 146433.78034954268D},
        new Object[]{"ETHIOPIA", 1994L, 223731.00827797136D},
        new Object[]{"ETHIOPIA", 1993L, 392406.45956127666D},
        new Object[]{"ETHIOPIA", 1992L, 120304.05524324537D},
        new Object[]{"GERMANY", 1998L, 106323.37565803422D},
        new Object[]{"GERMANY", 1997L, 92601.54000000001D},
        new Object[]{"GERMANY", 1996L, 198944.05598116558D},
        new Object[]{"GERMANY", 1995L, 165687.04067567262D},
        new Object[]{"GERMANY", 1994L, 226676.94357343644D},
        new Object[]{"GERMANY", 1993L, 141024.68808797607D},
        new Object[]{"GERMANY", 1992L, 293949.9785120052D},
        new Object[]{"INDIA", 1998L, 126584.38706637183D},
        new Object[]{"INDIA", 1997L, 242388.40911733187D},
        new Object[]{"INDIA", 1996L, 263227.16703907255D},
        new Object[]{"INDIA", 1995L, 205509.06789985023D},
        new Object[]{"INDIA", 1994L, 361137.8302702983D},
        new Object[]{"INDIA", 1993L, 283929.8668777271D},
        new Object[]{"INDIA", 1992L, 341885.8311905579D},
        new Object[]{"INDONESIA", 1998L, 274430.05162858486D},
        new Object[]{"INDONESIA", 1997L, 465366.50635826826D},
        new Object[]{"INDONESIA", 1996L, 500014.30167926016D},
        new Object[]{"INDONESIA", 1995L, 424459.63056589704D},
        new Object[]{"INDONESIA", 1994L, 346039.4309281166D},
        new Object[]{"INDONESIA", 1993L, 450136.5637882498D},
        new Object[]{"INDONESIA", 1992L, 602251.414583133D},
        new Object[]{"IRAN", 1998L, 131147.61823914346D},
        new Object[]{"IRAN", 1997L, 87582.15097435769D},
        new Object[]{"IRAN", 1996L, 95232.70604957585D},
        new Object[]{"IRAN", 1995L, 115417.67062810008D},
        new Object[]{"IRAN", 1994L, 190750.94539575384D},
        new Object[]{"IRAN", 1993L, 78173.58147189885D},
        new Object[]{"IRAN", 1992L, 9445.441430400575D},
        new Object[]{"IRAQ", 1998L, 64116.222065007096D},
        new Object[]{"IRAQ", 1997L, 53046.80409555316D},
        new Object[]{"IRAQ", 1996L, 98945.09816294358D},
        new Object[]{"IRAQ", 1994L, -791.6299371585264D},
        new Object[]{"IRAQ", 1993L, 112985.29805446045D},
        new Object[]{"IRAQ", 1992L, 90281.52294340223D},
        new Object[]{"JAPAN", 1998L, 134707.8442967207D},
        new Object[]{"JAPAN", 1997L, 187434.71473944635D},
        new Object[]{"JAPAN", 1996L, 130783.96095723026D},
        new Object[]{"JAPAN", 1995L, 245886.58956717473D},
        new Object[]{"JAPAN", 1994L, 96861.93096909914D},
        new Object[]{"JAPAN", 1993L, 91508.39774376526D},
        new Object[]{"JAPAN", 1992L, 319633.41638581344D},
        new Object[]{"JORDAN", 1998L, 84023.6913846031D},
        new Object[]{"JORDAN", 1997L, 248273.9293701095D},
        new Object[]{"JORDAN", 1996L, 303736.134965854D},
        new Object[]{"JORDAN", 1995L, 269849.51809366734D},
        new Object[]{"JORDAN", 1994L, 82437.45704854291D},
        new Object[]{"JORDAN", 1993L, 290887.21199729946D},
        new Object[]{"JORDAN", 1992L, 275791.7712003958D},
        new Object[]{"KENYA", 1998L, 74049.85009683366D},
        new Object[]{"KENYA", 1997L, 311392.67448551237D},
        new Object[]{"KENYA", 1996L, 185216.46649997216D},
        new Object[]{"KENYA", 1995L, 80162.49574048087D},
        new Object[]{"KENYA", 1994L, 302921.1920338205D},
        new Object[]{"KENYA", 1993L, 325086.9664950555D},
        new Object[]{"KENYA", 1992L, 343416.78546852164D},
        new Object[]{"MOROCCO", 1998L, 119855.49339878328D},
        new Object[]{"MOROCCO", 1997L, 290008.63337356696D},
        new Object[]{"MOROCCO", 1996L, 14184.126619798131D},
        new Object[]{"MOROCCO", 1995L, 69843.47769951589D},
        new Object[]{"MOROCCO", 1994L, 191099.55208847D},
        new Object[]{"MOROCCO", 1993L, 137202.08287584715D},
        new Object[]{"MOROCCO", 1992L, 66594.12967929705D},
        new Object[]{"MOZAMBIQUE", 1998L, 117097.67474634535D},
        new Object[]{"MOZAMBIQUE", 1997L, 363205.0374246483D},
        new Object[]{"MOZAMBIQUE", 1996L, 311449.2716963856D},
        new Object[]{"MOZAMBIQUE", 1995L, 473208.39547215303D},
        new Object[]{"MOZAMBIQUE", 1994L, 442759.0845858489D},
        new Object[]{"MOZAMBIQUE", 1993L, 440542.98936795373D},
        new Object[]{"MOZAMBIQUE", 1992L, 287795.5268082155D},
        new Object[]{"PERU", 1998L, 102725.66279401525D},
        new Object[]{"PERU", 1997L, 171472.8264013625D},
        new Object[]{"PERU", 1996L, 294416.15261718613D},
        new Object[]{"PERU", 1995L, 112348.73268373786D},
        new Object[]{"PERU", 1994L, 95837.18593006684D},
        new Object[]{"PERU", 1993L, 138317.5969789736D},
        new Object[]{"PERU", 1992L, 85667.16847534657D},
        new Object[]{"ROMANIA", 1998L, 2421.287401699462D},
        new Object[]{"ROMANIA", 1997L, 102189.50098745803D},
        new Object[]{"ROMANIA", 1996L, 81265.36594303243D},
        new Object[]{"ROMANIA", 1995L, 47749.04802742277D},
        new Object[]{"ROMANIA", 1994L, 35394.23633686883D},
        new Object[]{"ROMANIA", 1993L, 42641.98851210193D},
        new Object[]{"ROMANIA", 1992L, 49277.804907966856D},
        new Object[]{"RUSSIA", 1998L, 548958.6482764422D},
        new Object[]{"RUSSIA", 1997L, 466773.90985315753D},
        new Object[]{"RUSSIA", 1996L, 901266.0330275361D},
        new Object[]{"RUSSIA", 1995L, 803254.3646324245D},
        new Object[]{"RUSSIA", 1994L, 932974.120513519D},
        new Object[]{"RUSSIA", 1993L, 843491.4803470026D},
        new Object[]{"RUSSIA", 1992L, 876831.2496177027D},
        new Object[]{"UNITED KINGDOM", 1998L, 81480.06686721234D},
        new Object[]{"UNITED KINGDOM", 1997L, 58282.63452262785D},
        new Object[]{"UNITED KINGDOM", 1996L, 134110.58770714886D},
        new Object[]{"UNITED KINGDOM", 1995L, 83918.57284126579D},
        new Object[]{"UNITED KINGDOM", 1994L, 70544.89821118998D},
        new Object[]{"UNITED KINGDOM", 1993L, 55681.247072249615D},
        new Object[]{"UNITED KINGDOM", 1992L, 31602.86316145718D},
        new Object[]{"UNITED STATES", 1998L, 196681.86753583295D},
        new Object[]{"UNITED STATES", 1997L, 311459.70298314217D},
        new Object[]{"UNITED STATES", 1996L, 451144.5765293425D},
        new Object[]{"UNITED STATES", 1995L, 481350.94638033805D},
        new Object[]{"UNITED STATES", 1994L, 473742.82106392196D},
        new Object[]{"UNITED STATES", 1993L, 324866.8118531974D},
        new Object[]{"UNITED STATES", 1992L, 343496.2652782099D},
        new Object[]{"VIETNAM", 1998L, 198132.13110275078D},
        new Object[]{"VIETNAM", 1997L, 426951.29134074517D},
        new Object[]{"VIETNAM", 1996L, 610135.1674077166D},
        new Object[]{"VIETNAM", 1995L, 316695.85186926863D},
        new Object[]{"VIETNAM", 1994L, 489111.948197652D},
        new Object[]{"VIETNAM", 1993L, 343970.28961719247D},
        new Object[]{"VIETNAM", 1992L, 352275.066762814D}
    );
  }

  @Test
  public void tpch10() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "SELECT\n"
        + "    C_CUSTKEY,\n"
        + "    C_NAME,\n"
        + "    SUM(L_EXTENDEDPRICE * (1 - L_DISCOUNT)) AS REVENUE,\n"
        + "    C_ACCTBAL,\n"
        + "    N_NAME,\n"
        + "    C_ADDRESS,\n"
        + "    C_PHONE,\n"
        + "    C_COMMENT\n"
        + " FROM\n"
        + "    customer,\n"
        + "    orders,\n"
        + "    lineitem,\n"
        + "    nation\n"
        + " WHERE\n"
        + "    C_CUSTKEY = O_CUSTKEY\n"
        + "    AND L_ORDERKEY = O_ORDERKEY\n"
        + "    AND O_ORDERDATE >= '1993-07-01'\n"
        + "    AND O_ORDERDATE < '1993-10-01'\n"
        + "    AND L_RETURNFLAG = 'R'\n"
        + "    AND C_NATIONKEY = N_NATIONKEY\n"
        + " GROUP BY\n"
        + "    C_CUSTKEY,\n"
        + "    C_NAME,\n"
        + "    C_ACCTBAL,\n"
        + "    C_PHONE,\n"
        + "    N_NAME,\n"
        + "    C_ADDRESS,\n"
        + "    C_COMMENT\n"
        + " ORDER BY\n"
        + "    REVENUE DESC\n"
        + " LIMIT 20",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"customer+orders+lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"customer+orders\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"orders\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"orders\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"filter\" : {\n"
        + "                          \"type\" : \"bound\",\n"
        + "                          \"dimension\" : \"O_ORDERDATE\",\n"
        + "                          \"lower\" : \"1993-07-01\",\n"
        + "                          \"upper\" : \"1993-10-01\",\n"
        + "                          \"lowerStrict\" : false,\n"
        + "                          \"upperStrict\" : true,\n"
        + "                          \"comparatorType\" : \"lexicographic\"\n"
        + "                        },\n"
        + "                        \"columns\" : [ \"O_CUSTKEY\", \"O_ORDERDATE\", \"O_ORDERKEY\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"customer\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"customer\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"C_ACCTBAL\", \"C_ADDRESS\", \"C_COMMENT\", \"C_CUSTKEY\", \"C_NAME\", \"C_NATIONKEY\", \"C_PHONE\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"customer\",\n"
        + "                    \"leftJoinColumns\" : [ \"C_CUSTKEY\" ],\n"
        + "                    \"rightAlias\" : \"orders\",\n"
        + "                    \"rightJoinColumns\" : [ \"O_CUSTKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"prefixAlias\" : false,\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  },\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"customer\", \"orders\" ]\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              },\n"
        + "              \"lineitem\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"lineitem\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"selector\",\n"
        + "                    \"dimension\" : \"L_RETURNFLAG\",\n"
        + "                    \"value\" : \"R\"\n"
        + "                  },\n"
        + "                  \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_ORDERKEY\", \"L_RETURNFLAG\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"customer+orders\",\n"
        + "              \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "              \"rightAlias\" : \"lineitem\",\n"
        + "              \"rightJoinColumns\" : [ \"L_ORDERKEY\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"customer+orders\", \"lineitem\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"nation\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"nation\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"customer+orders+lineitem\",\n"
        + "        \"leftJoinColumns\" : [ \"C_NATIONKEY\" ],\n"
        + "        \"rightAlias\" : \"nation\",\n"
        + "        \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"customer+orders+lineitem\", \"nation\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_CUSTKEY\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_NAME\",\n"
        + "    \"outputName\" : \"d1\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_ACCTBAL\",\n"
        + "    \"outputName\" : \"d2\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_PHONE\",\n"
        + "    \"outputName\" : \"d3\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"N_NAME\",\n"
        + "    \"outputName\" : \"d4\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_ADDRESS\",\n"
        + "    \"outputName\" : \"d5\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_COMMENT\",\n"
        + "    \"outputName\" : \"d6\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"a0\"\n"
        + "    } ],\n"
        + "    \"limit\" : 20\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"d1\", \"a0\", \"d2\", \"d4\", \"d5\", \"d3\", \"d6\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"22", "Customer#000000022", 376659.3379452322D, 591.98D, "CANADA", "QI6p41,FNs5k7RZoCCVPUTkUdYpB", "13-806-545-9701", "s nod furiously above the furiously ironic ideas. "},
        new Object[]{"217", "Customer#000000217", 337546.5029809665D, 378.33D, "UNITED KINGDOM", "YIy05RMdthrXqdfnNKud", "33-159-298-3849", "ven frays wake according to the carefully "},
        new Object[]{"715", "Customer#000000715", 327733.10233764054D, 85.05D, "ROMANIA", "9qLvF42uxUarKl4I 2pEKOMNJmo8Ro5EK", "29-500-408-6392", "hins boost quickly. quickly regular epitaphs haggle fluffily quickly bold pinto beans. regular"},
        new Object[]{"55", "Customer#000000055", 325304.2184793751D, 4572.11D, "IRAN", "zIRBR4KNEl HzaiV3a i9n6elrxzDEh8r8pDom", "20-180-440-8525", "ully unusual packages wake bravely bold packages. unusual requests boost deposits! blithely ironic packages ab"},
        new Object[]{"19", "Customer#000000019", 295856.25229804683D, 8914.71D, "CHINA", "uc,3bHIx84H,wdrmLOjVsiqXCq2tr", "28-396-526-5053", " nag. furiously careful packages are slyly at the accounts. furiously regular in"},
        new Object[]{"686", "Customer#000000686", 284498.96677950415D, 5503.36D, "FRANCE", "1j C80VWHe ITCVCV", "16-682-293-3599", " even deposits print quickly. foxes wake. furiously ironic asymptotes across the bold foxes"},
        new Object[]{"202", "Customer#000000202", 280435.6192224468D, 2237.64D, "GERMANY", "Q0uJ1frCbi9yvu", "17-905-805-4635", "fully along the carefully pending Tiresias; special packages along the carefully special deposits try to"},
        new Object[]{"679", "Customer#000000679", 268885.680341735D, 1394.44D, "IRAN", "IJf1FlZL9I9m,rvofcoKy5pRUOjUQV", "20-146-696-9508", "ely pending frays boost carefully"},
        new Object[]{"448", "Customer#000000448", 260133.3756423737D, 8117.27D, "UNITED STATES", "BH4vtnDpabk0NgoGNJWu4OUXnidfJ", "34-985-422-6009", "unts. final pinto beans boost carefully. furiously even foxes according to the express, regular pa"},
        new Object[]{"394", "Customer#000000394", 245405.0088580988D, 5200.96D, "UNITED KINGDOM", "nxW1jt,MQvImdr z72gAt1bslnfEipCh,bKZN", "33-422-600-6936", " instructions. carefully special ideas after the fluffily unusual r"},
        new Object[]{"64", "Customer#000000064", 245401.5889329308D, -646.64D, "CANADA", "MbCeGY20kaKK3oalJD,OT", "13-558-731-7204", "structions after the quietly ironic theodolites cajole be"},
        new Object[]{"559", "Customer#000000559", 243818.187256828D, 5872.94D, "GERMANY", "A3ACFoVbP,gPe xknVJMWC,wmRxb Nmg fWFS,UP", "17-395-429-6655", "al accounts cajole carefully across the accounts. furiously pending pinto beans across the "},
        new Object[]{"586", "Customer#000000586", 242057.2150677127D, 5134.35D, "IRAQ", "vGaA9XBtn,hlswFhSjLIXGlLEDD2flE8UXwj", "21-239-369-7791", "above the blithely express ideas. slyly r"},
        new Object[]{"721", "Customer#000000721", 234606.65694861457D, 3420.64D, "VIETNAM", "N6hr4gV9EkPBuE3Ayu ", "31-174-552-2949", "ar instructions. packages haggle stealthily ironic deposits. even platelets detect quickly. even sheaves along"},
        new Object[]{"65", "Customer#000000065", 228551.89613367125D, 8795.16D, "UNITED KINGDOM", "RGT yzQ0y4l0H90P783LG4U95bXQFDRXbWa1sl,X", "33-733-623-5267", "y final foxes serve carefully. theodolites are carefully. pending i"},
        new Object[]{"352", "Customer#000000352", 226905.6798173411D, 6257.88D, "INDONESIA", "HqhIE5GRTK0dFtWpJUQENU4aa1bwdsUBEWtzUw", "19-906-158-8420", "ts are. blithely special requests wake. furiously bold packages among the blithely eve"},
        new Object[]{"79", "Customer#000000079", 220721.16073114896D, 5121.28D, "MOROCCO", "n5hH2ftkVRwW8idtD,BmM2", "25-147-850-4166", "es. packages haggle furiously. regular, special requests poach after the quickly express ideas. blithely pending re"},
        new Object[]{"710", "Customer#000000710", 217848.30989936687D, 7412.12D, "RUSSIA", "OCLSZuXw1AEK NLvlofMkuK,YNe,bJD40a", "32-459-427-9559", "ges integrate express, even ideas"},
        new Object[]{"484", "Customer#000000484", 213702.96280260698D, 4245.0D, "SAUDI ARABIA", "ismzlUzrqRMRGWmCEUUjkBsi", "30-777-953-8902", "y against the express, even packages. blithely pending pearls haggle furiously above the fur"},
        new Object[]{"292", "Customer#000000292", 203414.1759173521D, 2975.43D, "IRAQ", "hCXh3vxC4uje9", "21-457-910-2923", "usly regular, ironic accounts. blithely regular platelets are carefully. blithely unusual ideas affi"}
    );
  }

  @Test
  public void tpch11() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH q11_part_tmp_cached AS (\n"
        + " SELECT\n"
        + "    PS_PARTKEY,\n"
        + "    SUM(PS_SUPPLYCOST * PS_AVAILQTY) AS PART_VALUE\n"
        + " FROM\n"
        + "    partsupp,\n"
        + "    supplier,\n"
        + "    nation\n"
        + " WHERE\n"
        + "    PS_SUPPKEY = S_SUPPKEY\n"
        + "    AND S_NATIONKEY = N_NATIONKEY\n"
        + "    AND N_NAME = 'GERMANY'\n"
        + " GROUP BY PS_PARTKEY\n"
        + "),\n"
        + "q11_sum_tmp_cached  AS (\n"
        + " SELECT\n"
        + "    SUM(PART_VALUE) AS TOTAL_VALUE\n"
        + " FROM\n"
        + "    q11_part_tmp_cached\n"
        + ")\n"
        + "\n"
        + "SELECT\n"
        + "    PS_PARTKEY, PART_VALUE\n"
        + " FROM (\n"
        + "    SELECT\n"
        + "        PS_PARTKEY,\n"
        + "        PART_VALUE,\n"
        + "        TOTAL_VALUE\n"
        + "    FROM\n"
        + "        q11_part_tmp_cached CROSS JOIN q11_sum_tmp_cached\n"
        + ") A\n"
        + " WHERE\n"
        + "    PART_VALUE > TOTAL_VALUE * 0.0001\n"
        + " ORDER BY\n"
        + "    PART_VALUE DESC",
        "{\n"
        + "  \"queryType\" : \"select.stream\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"nation+supplier+partsupp\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"groupBy\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"partsupp\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"partsupp\"\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"columns\" : [ \"PS_AVAILQTY\", \"PS_PARTKEY\", \"PS_SUPPKEY\", \"PS_SUPPLYCOST\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"nation+supplier\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"join\",\n"
        + "                      \"dataSources\" : {\n"
        + "                        \"nation\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"select.stream\",\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"table\",\n"
        + "                              \"name\" : \"nation\"\n"
        + "                            },\n"
        + "                            \"descending\" : false,\n"
        + "                            \"filter\" : {\n"
        + "                              \"type\" : \"selector\",\n"
        + "                              \"dimension\" : \"N_NAME\",\n"
        + "                              \"value\" : \"GERMANY\"\n"
        + "                            },\n"
        + "                            \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "                            \"limitSpec\" : {\n"
        + "                              \"type\" : \"noop\"\n"
        + "                            },\n"
        + "                            \"context\" : {\n"
        + "                              \"groupby.sort.on.time\" : false\n"
        + "                            }\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"supplier\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"select.stream\",\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"table\",\n"
        + "                              \"name\" : \"supplier\"\n"
        + "                            },\n"
        + "                            \"descending\" : false,\n"
        + "                            \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                            \"limitSpec\" : {\n"
        + "                              \"type\" : \"noop\"\n"
        + "                            },\n"
        + "                            \"context\" : {\n"
        + "                              \"groupby.sort.on.time\" : false\n"
        + "                            }\n"
        + "                          }\n"
        + "                        }\n"
        + "                      },\n"
        + "                      \"elements\" : [ {\n"
        + "                        \"joinType\" : \"INNER\",\n"
        + "                        \"leftAlias\" : \"nation\",\n"
        + "                        \"leftJoinColumns\" : [ \"N_NATIONKEY\" ],\n"
        + "                        \"rightAlias\" : \"supplier\",\n"
        + "                        \"rightJoinColumns\" : [ \"S_NATIONKEY\" ]\n"
        + "                      } ],\n"
        + "                      \"prefixAlias\" : false,\n"
        + "                      \"asArray\" : true,\n"
        + "                      \"limit\" : 0,\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false\n"
        + "                      },\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"union\",\n"
        + "                        \"dataSources\" : [ \"nation\", \"supplier\" ]\n"
        + "                      },\n"
        + "                      \"descending\" : false\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"INNER\",\n"
        + "                  \"leftAlias\" : \"nation+supplier\",\n"
        + "                  \"leftJoinColumns\" : [ \"S_SUPPKEY\" ],\n"
        + "                  \"rightAlias\" : \"partsupp\",\n"
        + "                  \"rightJoinColumns\" : [ \"PS_SUPPKEY\" ]\n"
        + "                } ],\n"
        + "                \"prefixAlias\" : false,\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false\n"
        + "                },\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"nation+supplier\", \"partsupp\" ]\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"dimensions\" : [ {\n"
        + "              \"type\" : \"default\",\n"
        + "              \"dimension\" : \"PS_PARTKEY\",\n"
        + "              \"outputName\" : \"d0\"\n"
        + "            } ],\n"
        + "            \"aggregations\" : [ {\n"
        + "              \"type\" : \"sum\",\n"
        + "              \"name\" : \"a0\",\n"
        + "              \"fieldExpression\" : \"(\\\"PS_SUPPLYCOST\\\" * \\\"PS_AVAILQTY\\\")\",\n"
        + "              \"inputType\" : \"double\"\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"nation+supplier+partsupp$\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"timeseries\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"partsupp\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"partsupp\"\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"columns\" : [ \"PS_AVAILQTY\", \"PS_PARTKEY\", \"PS_SUPPKEY\", \"PS_SUPPLYCOST\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"nation+supplier\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"join\",\n"
        + "                      \"dataSources\" : {\n"
        + "                        \"nation\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"select.stream\",\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"table\",\n"
        + "                              \"name\" : \"nation\"\n"
        + "                            },\n"
        + "                            \"descending\" : false,\n"
        + "                            \"filter\" : {\n"
        + "                              \"type\" : \"selector\",\n"
        + "                              \"dimension\" : \"N_NAME\",\n"
        + "                              \"value\" : \"GERMANY\"\n"
        + "                            },\n"
        + "                            \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "                            \"limitSpec\" : {\n"
        + "                              \"type\" : \"noop\"\n"
        + "                            },\n"
        + "                            \"context\" : {\n"
        + "                              \"groupby.sort.on.time\" : false\n"
        + "                            }\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"supplier\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"select.stream\",\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"table\",\n"
        + "                              \"name\" : \"supplier\"\n"
        + "                            },\n"
        + "                            \"descending\" : false,\n"
        + "                            \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                            \"limitSpec\" : {\n"
        + "                              \"type\" : \"noop\"\n"
        + "                            },\n"
        + "                            \"context\" : {\n"
        + "                              \"groupby.sort.on.time\" : false\n"
        + "                            }\n"
        + "                          }\n"
        + "                        }\n"
        + "                      },\n"
        + "                      \"elements\" : [ {\n"
        + "                        \"joinType\" : \"INNER\",\n"
        + "                        \"leftAlias\" : \"nation\",\n"
        + "                        \"leftJoinColumns\" : [ \"N_NATIONKEY\" ],\n"
        + "                        \"rightAlias\" : \"supplier\",\n"
        + "                        \"rightJoinColumns\" : [ \"S_NATIONKEY\" ]\n"
        + "                      } ],\n"
        + "                      \"prefixAlias\" : false,\n"
        + "                      \"asArray\" : true,\n"
        + "                      \"limit\" : 0,\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false\n"
        + "                      },\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"union\",\n"
        + "                        \"dataSources\" : [ \"nation\", \"supplier\" ]\n"
        + "                      },\n"
        + "                      \"descending\" : false\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"INNER\",\n"
        + "                  \"leftAlias\" : \"nation+supplier\",\n"
        + "                  \"leftJoinColumns\" : [ \"S_SUPPKEY\" ],\n"
        + "                  \"rightAlias\" : \"partsupp\",\n"
        + "                  \"rightJoinColumns\" : [ \"PS_SUPPKEY\" ]\n"
        + "                } ],\n"
        + "                \"prefixAlias\" : false,\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false\n"
        + "                },\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"nation+supplier\", \"partsupp\" ]\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"aggregations\" : [ {\n"
        + "              \"type\" : \"sum\",\n"
        + "              \"name\" : \"a0\",\n"
        + "              \"fieldExpression\" : \"(\\\"PS_SUPPLYCOST\\\" * \\\"PS_AVAILQTY\\\")\",\n"
        + "              \"inputType\" : \"double\"\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"a0\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"nation+supplier+partsupp\",\n"
        + "        \"leftJoinColumns\" : [ ],\n"
        + "        \"rightAlias\" : \"nation+supplier+partsupp$\",\n"
        + "        \"rightJoinColumns\" : [ ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"nation+supplier+partsupp\", \"nation+supplier+partsupp$\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"descending\" : false,\n"
        + "  \"filter\" : {\n"
        + "    \"type\" : \"math\",\n"
        + "    \"expression\" : \"(\\\"a0\\\" > (\\\"a00\\\" * 0.0001B))\"\n"
        + "  },\n"
        + "  \"columns\" : [ \"d0\", \"a0\", \"a00\" ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"a0\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  }\n"
        + "}",
        new Object[]{"657", 7952582.180000001D},
        new Object[]{"527", 7799597.1899999995D},
        new Object[]{"570", 7665801.33D},
        new Object[]{"93", 7645677.04D},
        new Object[]{"187", 7363442.4D},
        new Object[]{"715", 7215116.4799999995D},
        new Object[]{"549", 7115227.5D},
        new Object[]{"143", 7037648.64D},
        new Object[]{"989", 6970889.640000001D},
        new Object[]{"69", 6970845.15D},
        new Object[]{"115", 6706677.33D},
        new Object[]{"668", 6702794.699999999D},
        new Object[]{"943", 6458641.7D},
        new Object[]{"619", 6381886.600000001D},
        new Object[]{"751", 6334687.3D},
        new Object[]{"493", 6144995.15D},
        new Object[]{"730", 6100067.88D},
        new Object[]{"693", 5819806.220000001D},
        new Object[]{"19", 5593808.0D},
        new Object[]{"386", 5475929.1899999995D},
        new Object[]{"82", 5434136.829999999D},
        new Object[]{"942", 5409015.8D},
        new Object[]{"182", 5191583.7299999995D},
        new Object[]{"543", 5189101.68D},
        new Object[]{"743", 5039271.42D},
        new Object[]{"993", 4973063.04D},
        new Object[]{"732", 4932809.82D},
        new Object[]{"163", 4901152.25D},
        new Object[]{"211", 4879076.01D},
        new Object[]{"516", 4676882.0D},
        new Object[]{"216", 4561143.8D},
        new Object[]{"826", 4410041.96D},
        new Object[]{"895", 4345555.02D},
        new Object[]{"597", 4341311.640000001D},
        new Object[]{"482", 4315726.819999999D},
        new Object[]{"198", 4315049.0D},
        new Object[]{"403", 4283221.600000001D},
        new Object[]{"981", 4259584.13D},
        new Object[]{"442", 4107626.12D},
        new Object[]{"521", 3913058.16D},
        new Object[]{"864", 3728780.16D},
        new Object[]{"582", 3717165.4000000004D},
        new Object[]{"837", 3640184.0100000002D},
        new Object[]{"423", 3602031.8000000003D},
        new Object[]{"293", 3463498.8D},
        new Object[]{"902", 3459429.6D},
        new Object[]{"832", 3447746.46D},
        new Object[]{"922", 3387665.52D},
        new Object[]{"933", 3368071.5D},
        new Object[]{"682", 3333963.96D},
        new Object[]{"140", 3155253.92D},
        new Object[]{"394", 3118101.5599999996D},
        new Object[]{"167", 3034999.03D},
        new Object[]{"382", 3014555.96D},
        new Object[]{"451", 2926228.56D},
        new Object[]{"7", 2834026.8D},
        new Object[]{"789", 2782828.96D},
        new Object[]{"704", 2761460.85D},
        new Object[]{"422", 2710606.7800000003D},
        new Object[]{"970", 2702851.9099999997D},
        new Object[]{"250", 2647099.56D},
        new Object[]{"43", 2587359.58D},
        new Object[]{"717", 2574344.56D},
        new Object[]{"443", 2382150.05D},
        new Object[]{"882", 2321004.56D},
        new Object[]{"245", 2319450.9D},
        new Object[]{"346", 2318315.7600000002D},
        new Object[]{"480", 2316197.2399999998D},
        new Object[]{"608", 2225519.48D},
        new Object[]{"856", 2211867.0D},
        new Object[]{"328", 2208471.1900000004D},
        new Object[]{"8", 2172003.9D},
        new Object[]{"848", 2136067.6D},
        new Object[]{"132", 2125100.6799999997D},
        new Object[]{"621", 2115063.27D},
        new Object[]{"67", 2107088.16D},
        new Object[]{"265", 2093560.02D},
        new Object[]{"193", 2077700.32D},
        new Object[]{"118", 2059808.86D},
        new Object[]{"298", 2026981.74D},
        new Object[]{"355", 2010156.61D},
        new Object[]{"559", 1987422.84D},
        new Object[]{"782", 1866799.55D},
        new Object[]{"574", 1797527.3D},
        new Object[]{"80", 1740096.97D},
        new Object[]{"532", 1682311.48D},
        new Object[]{"243", 1603235.16D},
        new Object[]{"762", 1594238.3D},
        new Object[]{"893", 1533657.58D},
        new Object[]{"643", 1512838.8D},
        new Object[]{"393", 1484779.2000000002D},
        new Object[]{"129", 1450282.92D},
        new Object[]{"412", 1446605.2D},
        new Object[]{"276", 1414562.67D},
        new Object[]{"632", 1408087.26D},
        new Object[]{"46", 1361500.28D},
        new Object[]{"104", 1340876.41D},
        new Object[]{"292", 1327114.13D},
        new Object[]{"741", 1270376.7999999998D},
        new Object[]{"227", 1235815.6800000002D},
        new Object[]{"259", 1178367.68D},
        new Object[]{"793", 1081096.2D},
        new Object[]{"932", 980620.6799999999D},
        new Object[]{"325", 971188.85D},
        new Object[]{"32", 894484.09D},
        new Object[]{"809", 858034.3400000001D},
        new Object[]{"962", 846619.25D},
        new Object[]{"885", 836872.4D},
        new Object[]{"874", 834634.7100000001D},
        new Object[]{"20", 832802.32D},
        new Object[]{"374", 729413.96D},
        new Object[]{"490", 720683.6D},
        new Object[]{"178", 695176.94D},
        new Object[]{"433", 680530.32D},
        new Object[]{"339", 654195.71D},
        new Object[]{"563", 643298.76D},
        new Object[]{"375", 601371.5499999999D},
        new Object[]{"843", 589964.5499999999D},
        new Object[]{"755", 554786.94D},
        new Object[]{"469", 499663.14999999997D},
        new Object[]{"903", 446803.76D},
        new Object[]{"913", 425798.64999999997D},
        new Object[]{"634", 420249.7D},
        new Object[]{"363", 400413.19999999995D},
        new Object[]{"706", 392540.80000000005D},
        new Object[]{"1000", 384893.60000000003D},
        new Object[]{"593", 381772.8D},
        new Object[]{"815", 377968.08D},
        new Object[]{"432", 370528.51999999996D},
        new Object[]{"472", 295403.24D},
        new Object[]{"152", 278490.62D},
        new Object[]{"610", 272143.99D},
        new Object[]{"766", 259972.93D},
        new Object[]{"31", 236051.49D},
        new Object[]{"307", 224806.82D},
        new Object[]{"538", 223747.85000000003D},
        new Object[]{"804", 222522.30000000002D},
        new Object[]{"232", 211879.92D},
        new Object[]{"778", 204061.15000000002D},
        new Object[]{"586", 185146.12D},
        new Object[]{"314", 171835.30000000002D},
        new Object[]{"982", 155171.73D},
        new Object[]{"234", 151548.0D},
        new Object[]{"54", 138952.64D},
        new Object[]{"951", 127107.90000000001D},
        new Object[]{"510", 125887.92D},
        new Object[]{"332", 112181.3D},
        new Object[]{"56", 69545.7D},
        new Object[]{"343", 56511.840000000004D},
        new Object[]{"461", 54348.78D}
    );
  }

  @Test
  public void tpch12() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "select\n"
        + "    L_SHIPMODE,\n"
        + "    sum(case\n"
        + "        when O_ORDERPRIORITY = '1-URGENT'\n"
        + "            or O_ORDERPRIORITY = '2-HIGH'\n"
        + "            then 1\n"
        + "        else 0\n"
        + "    end) as high_line_count,\n"
        + "    sum(case\n"
        + "        when O_ORDERPRIORITY <> '1-URGENT'\n"
        + "            and O_ORDERPRIORITY <> '2-HIGH'\n"
        + "            then 1\n"
        + "        else 0\n"
        + "    end) as low_line_count\n"
        + " from\n"
        + "    orders,\n"
        + "    lineitem\n"
        + " where\n"
        + "    O_ORDERKEY = L_ORDERKEY\n"
        + "    and L_SHIPMODE in ('REG AIR', 'MAIL')\n"
        + "    and L_COMMITDATE < L_RECEIPTDATE\n"
        + "    and L_SHIPDATE < L_COMMITDATE\n"
        + "    and L_RECEIPTDATE >= '1995-01-01'\n"
        + "    and L_RECEIPTDATE < '1996-01-01'\n"
        + " group by\n"
        + "    L_SHIPMODE\n"
        + " order by\n"
        + "    L_SHIPMODE",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"lineitem\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"and\",\n"
        + "              \"fields\" : [ {\n"
        + "                \"type\" : \"in\",\n"
        + "                \"dimension\" : \"L_SHIPMODE\",\n"
        + "                \"values\" : [ \"MAIL\", \"REG AIR\" ]\n"
        + "              }, {\n"
        + "                \"type\" : \"math\",\n"
        + "                \"expression\" : \"(\\\"L_COMMITDATE\\\" < \\\"L_RECEIPTDATE\\\")\"\n"
        + "              }, {\n"
        + "                \"type\" : \"math\",\n"
        + "                \"expression\" : \"(\\\"L_SHIPDATE\\\" < \\\"L_COMMITDATE\\\")\"\n"
        + "              }, {\n"
        + "                \"type\" : \"bound\",\n"
        + "                \"dimension\" : \"L_RECEIPTDATE\",\n"
        + "                \"lower\" : \"1995-01-01\",\n"
        + "                \"upper\" : \"1996-01-01\",\n"
        + "                \"lowerStrict\" : false,\n"
        + "                \"upperStrict\" : true,\n"
        + "                \"comparatorType\" : \"lexicographic\"\n"
        + "              } ]\n"
        + "            },\n"
        + "            \"columns\" : [ \"L_COMMITDATE\", \"L_ORDERKEY\", \"L_RECEIPTDATE\", \"L_SHIPDATE\", \"L_SHIPMODE\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"orders\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"orders\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"O_ORDERKEY\", \"O_ORDERPRIORITY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"orders\",\n"
        + "        \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "        \"rightAlias\" : \"lineitem\",\n"
        + "        \"rightJoinColumns\" : [ \"L_ORDERKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"orders\", \"lineitem\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"L_SHIPMODE\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"filtered\",\n"
        + "    \"aggregator\" : {\n"
        + "      \"type\" : \"count\",\n"
        + "      \"name\" : \"a0\"\n"
        + "    },\n"
        + "    \"filter\" : {\n"
        + "      \"type\" : \"in\",\n"
        + "      \"dimension\" : \"O_ORDERPRIORITY\",\n"
        + "      \"values\" : [ \"1-URGENT\", \"2-HIGH\" ]\n"
        + "    },\n"
        + "    \"name\" : \"a0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"filtered\",\n"
        + "    \"aggregator\" : {\n"
        + "      \"type\" : \"count\",\n"
        + "      \"name\" : \"a1\"\n"
        + "    },\n"
        + "    \"filter\" : {\n"
        + "      \"type\" : \"and\",\n"
        + "      \"fields\" : [ {\n"
        + "        \"type\" : \"not\",\n"
        + "        \"field\" : {\n"
        + "          \"type\" : \"selector\",\n"
        + "          \"dimension\" : \"O_ORDERPRIORITY\",\n"
        + "          \"value\" : \"1-URGENT\"\n"
        + "        }\n"
        + "      }, {\n"
        + "        \"type\" : \"not\",\n"
        + "        \"field\" : {\n"
        + "          \"type\" : \"selector\",\n"
        + "          \"dimension\" : \"O_ORDERPRIORITY\",\n"
        + "          \"value\" : \"2-HIGH\"\n"
        + "        }\n"
        + "      } ]\n"
        + "    },\n"
        + "    \"name\" : \"a1\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d0\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"a0\", \"a1\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"MAIL", 34L, 44L},
        new Object[]{"REG AIR", 37L, 43L}
    );
  }

  @Test
  public void tpch13() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "select\n"
        + "    c_count,\n"
        + "    count(*) as custdist\n"
        + " from (\n"
        + "   select\n"
        + "      C_CUSTKEY,\n"
        + "      count(O_ORDERKEY) as c_count\n"
        + "   from\n"
        + "      customer left outer join orders on C_CUSTKEY = O_CUSTKEY and O_COMMENT not like '%unusual%accounts%'\n"
        + "   group by C_CUSTKEY\n"
        + " ) c_orders\n"
        + " group by c_count\n"
        + " order by custdist desc, c_count desc",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"groupBy\",\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"query\",\n"
        + "        \"query\" : {\n"
        + "          \"queryType\" : \"join\",\n"
        + "          \"dataSources\" : {\n"
        + "            \"orders\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"select.stream\",\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"table\",\n"
        + "                  \"name\" : \"orders\"\n"
        + "                },\n"
        + "                \"descending\" : false,\n"
        + "                \"filter\" : {\n"
        + "                  \"type\" : \"not\",\n"
        + "                  \"field\" : {\n"
        + "                    \"type\" : \"like\",\n"
        + "                    \"dimension\" : \"O_COMMENT\",\n"
        + "                    \"pattern\" : \"%unusual%accounts%\"\n"
        + "                  }\n"
        + "                },\n"
        + "                \"columns\" : [ \"O_COMMENT\", \"O_CUSTKEY\", \"O_ORDERKEY\" ],\n"
        + "                \"limitSpec\" : {\n"
        + "                  \"type\" : \"noop\"\n"
        + "                },\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"customer\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"select.stream\",\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"table\",\n"
        + "                  \"name\" : \"customer\"\n"
        + "                },\n"
        + "                \"descending\" : false,\n"
        + "                \"columns\" : [ \"C_CUSTKEY\" ],\n"
        + "                \"limitSpec\" : {\n"
        + "                  \"type\" : \"noop\"\n"
        + "                },\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false\n"
        + "                }\n"
        + "              }\n"
        + "            }\n"
        + "          },\n"
        + "          \"elements\" : [ {\n"
        + "            \"joinType\" : \"LO\",\n"
        + "            \"leftAlias\" : \"customer\",\n"
        + "            \"leftJoinColumns\" : [ \"C_CUSTKEY\" ],\n"
        + "            \"rightAlias\" : \"orders\",\n"
        + "            \"rightJoinColumns\" : [ \"O_CUSTKEY\" ]\n"
        + "          } ],\n"
        + "          \"prefixAlias\" : false,\n"
        + "          \"asArray\" : true,\n"
        + "          \"limit\" : 0,\n"
        + "          \"context\" : {\n"
        + "            \"groupby.sort.on.time\" : false\n"
        + "          },\n"
        + "          \"dataSource\" : {\n"
        + "            \"type\" : \"union\",\n"
        + "            \"dataSources\" : [ \"customer\", \"orders\" ]\n"
        + "          },\n"
        + "          \"descending\" : false\n"
        + "        }\n"
        + "      },\n"
        + "      \"granularity\" : {\n"
        + "        \"type\" : \"all\"\n"
        + "      },\n"
        + "      \"dimensions\" : [ {\n"
        + "        \"type\" : \"default\",\n"
        + "        \"dimension\" : \"C_CUSTKEY\",\n"
        + "        \"outputName\" : \"d0\"\n"
        + "      } ],\n"
        + "      \"aggregations\" : [ {\n"
        + "        \"type\" : \"count\",\n"
        + "        \"name\" : \"a0\",\n"
        + "        \"fieldName\" : \"O_ORDERKEY\"\n"
        + "      } ],\n"
        + "      \"limitSpec\" : {\n"
        + "        \"type\" : \"noop\"\n"
        + "      },\n"
        + "      \"outputColumns\" : [ \"a0\" ],\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"a0\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"count\",\n"
        + "    \"name\" : \"_a0\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"_a0\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"d0\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"_a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{0L, 250L},
        new Object[]{12L, 34L},
        new Object[]{11L, 34L},
        new Object[]{19L, 29L},
        new Object[]{14L, 29L},
        new Object[]{8L, 28L},
        new Object[]{7L, 26L},
        new Object[]{20L, 25L},
        new Object[]{17L, 24L},
        new Object[]{13L, 24L},
        new Object[]{9L, 24L},
        new Object[]{18L, 23L},
        new Object[]{16L, 23L},
        new Object[]{15L, 22L},
        new Object[]{21L, 21L},
        new Object[]{10L, 19L},
        new Object[]{6L, 18L},
        new Object[]{23L, 17L},
        new Object[]{22L, 17L},
        new Object[]{27L, 9L},
        new Object[]{26L, 9L},
        new Object[]{24L, 9L},
        new Object[]{5L, 9L},
        new Object[]{4L, 8L},
        new Object[]{25L, 6L},
        new Object[]{30L, 4L},
        new Object[]{29L, 4L},
        new Object[]{28L, 2L},
        new Object[]{3L, 2L},
        new Object[]{2L, 1L}
    );
  }


  @Test
  public void tpch14() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "select\n"
        + " 100.00 * sum(case\n"
        + "    when P_TYPE like 'PROMO%'\n"
        + "      then L_EXTENDEDPRICE * (1 - L_DISCOUNT)\n"
        + "    else 0\n"
        + "  end) / sum(L_EXTENDEDPRICE * (1 - L_DISCOUNT)) as promo_revenue\n"
        + " from\n"
        + "  lineitem,\n"
        + "  part\n"
        + " where\n"
        + "  L_PARTKEY = P_PARTKEY\n"
        + " and L_SHIPDATE >= '1995-08-01'\n"
        + " and L_SHIPDATE < '1995-09-01'",
        "{\n"
        + "  \"queryType\" : \"timeseries\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"lineitem\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"bound\",\n"
        + "              \"dimension\" : \"L_SHIPDATE\",\n"
        + "              \"lower\" : \"1995-08-01\",\n"
        + "              \"upper\" : \"1995-09-01\",\n"
        + "              \"lowerStrict\" : false,\n"
        + "              \"upperStrict\" : true,\n"
        + "              \"comparatorType\" : \"lexicographic\"\n"
        + "            },\n"
        + "            \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_PARTKEY\", \"L_SHIPDATE\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"part\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"part\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"P_PARTKEY\", \"P_TYPE\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"lineitem\",\n"
        + "        \"leftJoinColumns\" : [ \"L_PARTKEY\" ],\n"
        + "        \"rightAlias\" : \"part\",\n"
        + "        \"rightJoinColumns\" : [ \"P_PARTKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"lineitem\", \"part\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"descending\" : false,\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"case(like(\\\"P_TYPE\\\",'PROMO%'),(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\")),0)\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  }, {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a1\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"postAggregations\" : [ {\n"
        + "    \"type\" : \"math\",\n"
        + "    \"name\" : \"p0\",\n"
        + "    \"expression\" : \"((100.00B * \\\"a0\\\") / \\\"a1\\\")\",\n"
        + "    \"finalize\" : true\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"noop\"\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"p0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  }\n"
        + "}",
        new Object[]{21.62198225363824}
    );
  }

  @Test
  public void tpch15() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH revenue_cached AS (\n"
        + " SELECT\n"
        + "    L_SUPPKEY AS SUPPLIER_NO,\n"
        + " SUM(L_EXTENDEDPRICE * (1 - L_DISCOUNT)) AS TOTAL_REVENUE\n"
        + " FROM\n"
        + "    lineitem\n"
        + " WHERE\n"
        + "    L_SHIPDATE >= '1996-01-01'\n"
        + " AND L_SHIPDATE < '1996-04-01'\n"
        + " GROUP BY L_SUPPKEY\n"
        + "),\n"
        + "max_revenue_cached AS (\n"
        + " SELECT\n"
        + " MAX(TOTAL_REVENUE) AS MAX_REVENUE\n"
        + " FROM\n"
        + "    revenue_cached\n"
        + ")\n"
        + " SELECT\n"
        + "    S_SUPPKEY,\n"
        + "    S_NAME,\n"
        + "    S_ADDRESS,\n"
        + "    S_PHONE,\n"
        + "    TOTAL_REVENUE\n"
        + " FROM\n"
        + "    supplier,\n"
        + "    revenue_cached,\n"
        + "    max_revenue_cached\n"
        + " WHERE\n"
        + "    S_SUPPKEY = SUPPLIER_NO\n"
        + " AND TOTAL_REVENUE = MAX_REVENUE\n"
        + " ORDER BY S_SUPPKEY",
        "{\n"
        + "  \"queryType\" : \"select.stream\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"supplier+lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"lineitem\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"groupBy\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"lineitem\"\n"
        + "                  },\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"bound\",\n"
        + "                    \"dimension\" : \"L_SHIPDATE\",\n"
        + "                    \"lower\" : \"1996-01-01\",\n"
        + "                    \"upper\" : \"1996-04-01\",\n"
        + "                    \"lowerStrict\" : false,\n"
        + "                    \"upperStrict\" : true,\n"
        + "                    \"comparatorType\" : \"lexicographic\"\n"
        + "                  },\n"
        + "                  \"granularity\" : {\n"
        + "                    \"type\" : \"all\"\n"
        + "                  },\n"
        + "                  \"dimensions\" : [ {\n"
        + "                    \"type\" : \"default\",\n"
        + "                    \"dimension\" : \"L_SUPPKEY\",\n"
        + "                    \"outputName\" : \"d0\"\n"
        + "                  } ],\n"
        + "                  \"aggregations\" : [ {\n"
        + "                    \"type\" : \"sum\",\n"
        + "                    \"name\" : \"a0\",\n"
        + "                    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "                    \"inputType\" : \"double\"\n"
        + "                  } ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              },\n"
        + "              \"supplier\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"supplier\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"columns\" : [ \"S_ADDRESS\", \"S_NAME\", \"S_PHONE\", \"S_SUPPKEY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"supplier\",\n"
        + "              \"leftJoinColumns\" : [ \"S_SUPPKEY\" ],\n"
        + "              \"rightAlias\" : \"lineitem\",\n"
        + "              \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"supplier\", \"lineitem\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"timeseries\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"groupBy\",\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"table\",\n"
        + "                  \"name\" : \"lineitem\"\n"
        + "                },\n"
        + "                \"filter\" : {\n"
        + "                  \"type\" : \"bound\",\n"
        + "                  \"dimension\" : \"L_SHIPDATE\",\n"
        + "                  \"lower\" : \"1996-01-01\",\n"
        + "                  \"upper\" : \"1996-04-01\",\n"
        + "                  \"lowerStrict\" : false,\n"
        + "                  \"upperStrict\" : true,\n"
        + "                  \"comparatorType\" : \"lexicographic\"\n"
        + "                },\n"
        + "                \"granularity\" : {\n"
        + "                  \"type\" : \"all\"\n"
        + "                },\n"
        + "                \"dimensions\" : [ {\n"
        + "                  \"type\" : \"default\",\n"
        + "                  \"dimension\" : \"L_SUPPKEY\",\n"
        + "                  \"outputName\" : \"d0\"\n"
        + "                } ],\n"
        + "                \"aggregations\" : [ {\n"
        + "                  \"type\" : \"sum\",\n"
        + "                  \"name\" : \"a0\",\n"
        + "                  \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "                  \"inputType\" : \"double\"\n"
        + "                } ],\n"
        + "                \"limitSpec\" : {\n"
        + "                  \"type\" : \"noop\"\n"
        + "                },\n"
        + "                \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"aggregations\" : [ {\n"
        + "              \"type\" : \"max\",\n"
        + "              \"name\" : \"_a0\",\n"
        + "              \"fieldName\" : \"a0\",\n"
        + "              \"inputType\" : \"double\"\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"_a0\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"supplier+lineitem\",\n"
        + "        \"leftJoinColumns\" : [ \"a0\" ],\n"
        + "        \"rightAlias\" : \"lineitem\",\n"
        + "        \"rightJoinColumns\" : [ \"_a0\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"supplier+lineitem\", \"lineitem\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"descending\" : false,\n"
        + "  \"columns\" : [ \"_a0\", \"d0\", \"a0\", \"S_ADDRESS\", \"S_NAME\", \"S_PHONE\", \"S_SUPPKEY\" ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"S_SUPPKEY\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"S_SUPPKEY\", \"S_NAME\", \"S_ADDRESS\", \"S_PHONE\", \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  }\n"
        + "}",
        new Object[]{"6", "Supplier#000000006", "tQxuVm7s7CnK", "24-696-997-4969", 1080265.1420867585D}
    );
  }


  @Test
  public void tpch16() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "select\n"
        + "    P_BRAND,\n"
        + "    P_TYPE,\n"
        + "    P_SIZE,\n"
        + "    count(distinct PS_SUPPKEY) as supplier_cnt\n"
        + " from\n"
        + "    partsupp,\n"
        + "    part\n"
        + " where\n"
        + "    P_PARTKEY = PS_PARTKEY\n"
        + "    and P_BRAND <> 'Brand#34'\n"
        + "    and P_TYPE not like 'ECONOMY BRUSHED%'\n"
        + "    and P_SIZE in (22, 14, 27, 49, 21, 33, 35, 28)\n"
        + "    and partsupp.PS_SUPPKEY not in (\n"
        + "        select\n"
        + "            S_SUPPKEY\n"
        + "        from\n"
        + "            supplier\n"
        + "        where\n"
        + "            S_COMMENT like '%Customer%Complaints%'\n"
        + "    )\n"
        + " group by\n"
        + "    P_BRAND,\n"
        + "    P_TYPE,\n"
        + "    P_SIZE\n"
        + " order by\n"
        + "    supplier_cnt desc,\n"
        + "    P_BRAND,\n"
        + "    P_TYPE,\n"
        + "    P_SIZE",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"supplier\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"groupBy\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"supplier\"\n"
        + "            },\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"like\",\n"
        + "              \"dimension\" : \"S_COMMENT\",\n"
        + "              \"pattern\" : \"%Customer%Complaints%\"\n"
        + "            },\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"dimensions\" : [ {\n"
        + "              \"type\" : \"default\",\n"
        + "              \"dimension\" : \"S_SUPPKEY\",\n"
        + "              \"outputName\" : \"d0\"\n"
        + "            }, {\n"
        + "              \"type\" : \"default\",\n"
        + "              \"dimension\" : \"d1:v\",\n"
        + "              \"outputName\" : \"d1\"\n"
        + "            } ],\n"
        + "            \"virtualColumns\" : [ {\n"
        + "              \"type\" : \"expr\",\n"
        + "              \"expression\" : \"true\",\n"
        + "              \"outputName\" : \"d1:v\"\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"d0\", \"d1\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"partsupp+part+supplier\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"supplier\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"timeseries\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"supplier\"\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"like\",\n"
        + "                    \"dimension\" : \"S_COMMENT\",\n"
        + "                    \"pattern\" : \"%Customer%Complaints%\"\n"
        + "                  },\n"
        + "                  \"granularity\" : {\n"
        + "                    \"type\" : \"all\"\n"
        + "                  },\n"
        + "                  \"aggregations\" : [ {\n"
        + "                    \"type\" : \"count\",\n"
        + "                    \"name\" : \"a0\"\n"
        + "                  }, {\n"
        + "                    \"type\" : \"count\",\n"
        + "                    \"name\" : \"a1\",\n"
        + "                    \"fieldName\" : \"S_SUPPKEY\"\n"
        + "                  } ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"outputColumns\" : [ \"a0\", \"a1\" ],\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  }\n"
        + "                }\n"
        + "              },\n"
        + "              \"partsupp+part\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"partsupp\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"partsupp\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"PS_PARTKEY\", \"PS_SUPPKEY\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"part\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"part\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"filter\" : {\n"
        + "                          \"type\" : \"and\",\n"
        + "                          \"fields\" : [ {\n"
        + "                            \"type\" : \"not\",\n"
        + "                            \"field\" : {\n"
        + "                              \"type\" : \"selector\",\n"
        + "                              \"dimension\" : \"P_BRAND\",\n"
        + "                              \"value\" : \"Brand#34\"\n"
        + "                            }\n"
        + "                          }, {\n"
        + "                            \"type\" : \"in\",\n"
        + "                            \"dimension\" : \"P_SIZE\",\n"
        + "                            \"values\" : [ \"14\", \"21\", \"22\", \"27\", \"28\", \"33\", \"35\", \"49\" ]\n"
        + "                          }, {\n"
        + "                            \"type\" : \"not\",\n"
        + "                            \"field\" : {\n"
        + "                              \"type\" : \"like\",\n"
        + "                              \"dimension\" : \"P_TYPE\",\n"
        + "                              \"pattern\" : \"ECONOMY BRUSHED%\"\n"
        + "                            }\n"
        + "                          } ]\n"
        + "                        },\n"
        + "                        \"columns\" : [ \"P_BRAND\", \"P_PARTKEY\", \"P_SIZE\", \"P_TYPE\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false\n"
        + "                        }\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"partsupp\",\n"
        + "                    \"leftJoinColumns\" : [ \"PS_PARTKEY\" ],\n"
        + "                    \"rightAlias\" : \"part\",\n"
        + "                    \"rightJoinColumns\" : [ \"P_PARTKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"prefixAlias\" : false,\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false\n"
        + "                  },\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"partsupp\", \"part\" ]\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"partsupp+part\",\n"
        + "              \"leftJoinColumns\" : [ ],\n"
        + "              \"rightAlias\" : \"supplier\",\n"
        + "              \"rightJoinColumns\" : [ ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"partsupp+part\", \"supplier\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"LO\",\n"
        + "        \"leftAlias\" : \"partsupp+part+supplier\",\n"
        + "        \"leftJoinColumns\" : [ \"PS_SUPPKEY\" ],\n"
        + "        \"rightAlias\" : \"supplier\",\n"
        + "        \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"partsupp+part+supplier\", \"supplier\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"filter\" : {\n"
        + "    \"type\" : \"or\",\n"
        + "    \"fields\" : [ {\n"
        + "      \"type\" : \"selector\",\n"
        + "      \"dimension\" : \"a0\",\n"
        + "      \"value\" : \"0\"\n"
        + "    }, {\n"
        + "      \"type\" : \"and\",\n"
        + "      \"fields\" : [ {\n"
        + "        \"type\" : \"selector\",\n"
        + "        \"dimension\" : \"d1\",\n"
        + "        \"value\" : \"\"\n"
        + "      }, {\n"
        + "        \"type\" : \"math\",\n"
        + "        \"expression\" : \"(\\\"a1\\\" >= \\\"a0\\\")\"\n"
        + "      }, {\n"
        + "        \"type\" : \"not\",\n"
        + "        \"field\" : {\n"
        + "          \"type\" : \"selector\",\n"
        + "          \"dimension\" : \"PS_SUPPKEY\",\n"
        + "          \"value\" : \"\"\n"
        + "        }\n"
        + "      } ]\n"
        + "    } ]\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"P_BRAND\",\n"
        + "    \"outputName\" : \"_d0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"P_SIZE\",\n"
        + "    \"outputName\" : \"_d1\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"P_TYPE\",\n"
        + "    \"outputName\" : \"_d2\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"cardinality\",\n"
        + "    \"name\" : \"_a0\",\n"
        + "    \"fields\" : [ {\n"
        + "      \"type\" : \"default\",\n"
        + "      \"dimension\" : \"PS_SUPPKEY\",\n"
        + "      \"outputName\" : \"PS_SUPPKEY\"\n"
        + "    } ],\n"
        + "    \"byRow\" : false,\n"
        + "    \"round\" : true\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"_a0\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"_d0\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"_d2\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"_d1\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"_d0\", \"_d2\", \"_d1\", \"_a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}"
    );
  }


  @Test
  public void tpch17() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH Q17_PART AS (\n"
        + "  SELECT P_PARTKEY FROM part WHERE\n"
        + "  P_BRAND = 'Brand#23'\n"
        + "  AND P_CONTAINER = 'MED BOX'\n"
        + "),\n"
        + "Q17_AVG AS (\n"
        + "  SELECT L_PARTKEY AS T_PARTKEY, 0.2 * AVG(L_QUANTITY) AS T_AVG_QUANTITY\n"
        + "  FROM lineitem\n"
        + "  WHERE L_PARTKEY IN (SELECT P_PARTKEY FROM Q17_PART)\n"
        + "  GROUP BY L_PARTKEY\n"
        + "),\n"
        + "Q17_PRICE AS (\n"
        + "  SELECT\n"
        + "  L_QUANTITY,\n"
        + "  L_PARTKEY,\n"
        + "  L_EXTENDEDPRICE\n"
        + "  FROM\n"
        + "  lineitem\n"
        + "  WHERE\n"
        + "  L_PARTKEY IN (SELECT P_PARTKEY FROM Q17_PART)\n"
        + ")\n"
        + " SELECT CAST(SUM(L_EXTENDEDPRICE) / 7.0 AS DECIMAL(32,2)) AS AVG_YEARLY\n"
        + " FROM Q17_AVG, Q17_PRICE\n"
        + " WHERE\n"
        + " T_PARTKEY = L_PARTKEY AND L_QUANTITY < T_AVG_QUANTITY",
        "{\n"
        + "  \"queryType\" : \"timeseries\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"lineitem+part\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"groupBy\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"lineitem\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"lineitem\"\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"columns\" : [ \"L_PARTKEY\", \"L_QUANTITY\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"part\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"groupBy\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"part\"\n"
        + "                      },\n"
        + "                      \"filter\" : {\n"
        + "                        \"type\" : \"and\",\n"
        + "                        \"fields\" : [ {\n"
        + "                          \"type\" : \"selector\",\n"
        + "                          \"dimension\" : \"P_BRAND\",\n"
        + "                          \"value\" : \"Brand#23\"\n"
        + "                        }, {\n"
        + "                          \"type\" : \"selector\",\n"
        + "                          \"dimension\" : \"P_CONTAINER\",\n"
        + "                          \"value\" : \"MED BOX\"\n"
        + "                        } ]\n"
        + "                      },\n"
        + "                      \"granularity\" : {\n"
        + "                        \"type\" : \"all\"\n"
        + "                      },\n"
        + "                      \"dimensions\" : [ {\n"
        + "                        \"type\" : \"default\",\n"
        + "                        \"dimension\" : \"P_PARTKEY\",\n"
        + "                        \"outputName\" : \"d0\"\n"
        + "                      } ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"outputColumns\" : [ \"d0\" ],\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      },\n"
        + "                      \"descending\" : false\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"INNER\",\n"
        + "                  \"leftAlias\" : \"lineitem\",\n"
        + "                  \"leftJoinColumns\" : [ \"L_PARTKEY\" ],\n"
        + "                  \"rightAlias\" : \"part\",\n"
        + "                  \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "                } ],\n"
        + "                \"prefixAlias\" : false,\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false,\n"
        + "                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                },\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"lineitem\", \"part\" ]\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"dimensions\" : [ {\n"
        + "              \"type\" : \"default\",\n"
        + "              \"dimension\" : \"L_PARTKEY\",\n"
        + "              \"outputName\" : \"_d0\"\n"
        + "            } ],\n"
        + "            \"aggregations\" : [ {\n"
        + "              \"type\" : \"sum\",\n"
        + "              \"name\" : \"a0:sum\",\n"
        + "              \"fieldName\" : \"L_QUANTITY\",\n"
        + "              \"inputType\" : \"long\"\n"
        + "            }, {\n"
        + "              \"type\" : \"count\",\n"
        + "              \"name\" : \"a0:count\"\n"
        + "            } ],\n"
        + "            \"postAggregations\" : [ {\n"
        + "              \"type\" : \"arithmetic\",\n"
        + "              \"name\" : \"a0\",\n"
        + "              \"fn\" : \"quotient\",\n"
        + "              \"fields\" : [ {\n"
        + "                \"type\" : \"fieldAccess\",\n"
        + "                \"fieldName\" : \"a0:sum\"\n"
        + "              }, {\n"
        + "                \"type\" : \"fieldAccess\",\n"
        + "                \"fieldName\" : \"a0:count\"\n"
        + "              } ]\n"
        + "            }, {\n"
        + "              \"type\" : \"math\",\n"
        + "              \"name\" : \"p0\",\n"
        + "              \"expression\" : \"(0.2B * \\\"a0\\\")\",\n"
        + "              \"finalize\" : true\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"_d0\", \"p0\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"lineitem+part$\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"lineitem\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"lineitem\"\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"columns\" : [ \"L_EXTENDEDPRICE\", \"L_PARTKEY\", \"L_QUANTITY\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"part\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"groupBy\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"part\"\n"
        + "                      },\n"
        + "                      \"filter\" : {\n"
        + "                        \"type\" : \"and\",\n"
        + "                        \"fields\" : [ {\n"
        + "                          \"type\" : \"selector\",\n"
        + "                          \"dimension\" : \"P_BRAND\",\n"
        + "                          \"value\" : \"Brand#23\"\n"
        + "                        }, {\n"
        + "                          \"type\" : \"selector\",\n"
        + "                          \"dimension\" : \"P_CONTAINER\",\n"
        + "                          \"value\" : \"MED BOX\"\n"
        + "                        } ]\n"
        + "                      },\n"
        + "                      \"granularity\" : {\n"
        + "                        \"type\" : \"all\"\n"
        + "                      },\n"
        + "                      \"dimensions\" : [ {\n"
        + "                        \"type\" : \"default\",\n"
        + "                        \"dimension\" : \"P_PARTKEY\",\n"
        + "                        \"outputName\" : \"d0\"\n"
        + "                      } ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"outputColumns\" : [ \"d0\" ],\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      },\n"
        + "                      \"descending\" : false\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"INNER\",\n"
        + "                  \"leftAlias\" : \"lineitem\",\n"
        + "                  \"leftJoinColumns\" : [ \"L_PARTKEY\" ],\n"
        + "                  \"rightAlias\" : \"part\",\n"
        + "                  \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "                } ],\n"
        + "                \"prefixAlias\" : false,\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false,\n"
        + "                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                },\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"lineitem\", \"part\" ]\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"L_QUANTITY\", \"L_PARTKEY\", \"L_EXTENDEDPRICE\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"lineitem+part\",\n"
        + "        \"leftJoinColumns\" : [ \"_d0\" ],\n"
        + "        \"rightAlias\" : \"lineitem+part$\",\n"
        + "        \"rightJoinColumns\" : [ \"L_PARTKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false,\n"
        + "        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"lineitem+part\", \"lineitem+part$\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"descending\" : false,\n"
        + "  \"filter\" : {\n"
        + "    \"type\" : \"math\",\n"
        + "    \"expression\" : \"(\\\"L_QUANTITY\\\" < \\\"p0\\\")\"\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldName\" : \"L_EXTENDEDPRICE\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"postAggregations\" : [ {\n"
        + "    \"type\" : \"math\",\n"
        + "    \"name\" : \"p0\",\n"
        + "    \"expression\" : \"CAST((\\\"a0\\\" / 7.0B), 'decimal')\",\n"
        + "    \"finalize\" : true\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"noop\"\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"p0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false,\n"
        + "    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "  }\n"
        + "}"
    );
  }

  @Test
  public void tpch18() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH q18_tmp_cached AS (\n"
        + "SELECT\n"
        + "    L_ORDERKEY,\n"
        + " SUM(L_QUANTITY) AS T_SUM_QUANTITY\n"
        + " FROM\n"
        + "    lineitem\n"
        + " WHERE\n"
        + "    L_ORDERKEY IS NOT NULL\n"
        + " GROUP BY\n"
        + "    L_ORDERKEY\n"
        + ")\n"
        + "SELECT\n"
        + "    C_NAME,\n"
        + "    C_CUSTKEY,\n"
        + "    O_ORDERKEY,\n"
        + "    O_ORDERDATE,\n"
        + "    O_TOTALPRICE,\n"
        + " SUM(L_QUANTITY)\n"
        + " FROM\n"
        + "    customer,\n"
        + "    orders,\n"
        + "    q18_tmp_cached T,\n"
        + "    lineitem L\n"
        + " WHERE\n"
        + "    C_CUSTKEY = O_CUSTKEY\n"
        + " AND O_ORDERKEY = T.L_ORDERKEY\n"
        + " AND O_ORDERKEY IS NOT NULL\n"
        + " AND T.T_SUM_QUANTITY > 300\n"
        + " AND O_ORDERKEY = L.L_ORDERKEY\n"
        + " AND L.L_ORDERKEY IS NOT NULL\n"
        + " GROUP BY\n"
        + "    C_NAME,\n"
        + "    C_CUSTKEY,\n"
        + "    O_ORDERKEY,\n"
        + "    O_ORDERDATE,\n"
        + "    O_TOTALPRICE\n"
        + " ORDER BY\n"
        + "    O_TOTALPRICE DESC,\n"
        + "    O_ORDERDATE\n"
        + " LIMIT 100",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"lineitem\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"L_ORDERKEY\", \"L_QUANTITY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"customer+orders+lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"customer+orders\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"join\",\n"
        + "                  \"dataSources\" : {\n"
        + "                    \"orders\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"orders\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"O_CUSTKEY\", \"O_ORDERDATE\", \"O_ORDERKEY\", \"O_TOTALPRICE\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false,\n"
        + "                          \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                        }\n"
        + "                      }\n"
        + "                    },\n"
        + "                    \"customer\" : {\n"
        + "                      \"type\" : \"query\",\n"
        + "                      \"query\" : {\n"
        + "                        \"queryType\" : \"select.stream\",\n"
        + "                        \"dataSource\" : {\n"
        + "                          \"type\" : \"table\",\n"
        + "                          \"name\" : \"customer\"\n"
        + "                        },\n"
        + "                        \"descending\" : false,\n"
        + "                        \"columns\" : [ \"C_CUSTKEY\", \"C_NAME\" ],\n"
        + "                        \"limitSpec\" : {\n"
        + "                          \"type\" : \"noop\"\n"
        + "                        },\n"
        + "                        \"context\" : {\n"
        + "                          \"groupby.sort.on.time\" : false,\n"
        + "                          \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                        }\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"elements\" : [ {\n"
        + "                    \"joinType\" : \"INNER\",\n"
        + "                    \"leftAlias\" : \"customer\",\n"
        + "                    \"leftJoinColumns\" : [ \"C_CUSTKEY\" ],\n"
        + "                    \"rightAlias\" : \"orders\",\n"
        + "                    \"rightJoinColumns\" : [ \"O_CUSTKEY\" ]\n"
        + "                  } ],\n"
        + "                  \"prefixAlias\" : false,\n"
        + "                  \"asArray\" : true,\n"
        + "                  \"limit\" : 0,\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false,\n"
        + "                    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                  },\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"union\",\n"
        + "                    \"dataSources\" : [ \"customer\", \"orders\" ]\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              },\n"
        + "              \"lineitem\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"groupBy\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"lineitem\"\n"
        + "                  },\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"not\",\n"
        + "                    \"field\" : {\n"
        + "                      \"type\" : \"selector\",\n"
        + "                      \"dimension\" : \"L_ORDERKEY\",\n"
        + "                      \"value\" : \"\"\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"granularity\" : {\n"
        + "                    \"type\" : \"all\"\n"
        + "                  },\n"
        + "                  \"dimensions\" : [ {\n"
        + "                    \"type\" : \"default\",\n"
        + "                    \"dimension\" : \"L_ORDERKEY\",\n"
        + "                    \"outputName\" : \"d0\"\n"
        + "                  } ],\n"
        + "                  \"aggregations\" : [ {\n"
        + "                    \"type\" : \"sum\",\n"
        + "                    \"name\" : \"a0\",\n"
        + "                    \"fieldName\" : \"L_QUANTITY\",\n"
        + "                    \"inputType\" : \"long\"\n"
        + "                  } ],\n"
        + "                  \"having\" : {\n"
        + "                    \"type\" : \"expression\",\n"
        + "                    \"expression\" : \"(\\\"a0\\\" > 300)\"\n"
        + "                  },\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false,\n"
        + "                    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"customer+orders\",\n"
        + "              \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "              \"rightAlias\" : \"lineitem\",\n"
        + "              \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"customer+orders\", \"lineitem\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"customer+orders+lineitem\",\n"
        + "        \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "        \"rightAlias\" : \"lineitem\",\n"
        + "        \"rightJoinColumns\" : [ \"L_ORDERKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false,\n"
        + "        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"customer+orders+lineitem\", \"lineitem\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_CUSTKEY\",\n"
        + "    \"outputName\" : \"_d0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"C_NAME\",\n"
        + "    \"outputName\" : \"_d1\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"O_ORDERDATE\",\n"
        + "    \"outputName\" : \"_d2\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"O_ORDERKEY\",\n"
        + "    \"outputName\" : \"_d3\"\n"
        + "  }, {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"O_TOTALPRICE\",\n"
        + "    \"outputName\" : \"_d4\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"_a0\",\n"
        + "    \"fieldName\" : \"L_QUANTITY\",\n"
        + "    \"inputType\" : \"long\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"_d4\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"_d2\"\n"
        + "    } ],\n"
        + "    \"limit\" : 100\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"_d1\", \"_d0\", \"_d3\", \"_d2\", \"_d4\", \"_a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false,\n"
        + "    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}",
        new Object[]{"Customer#000000334", "334", "29158", "1995-10-21", 441562.47D, 305L},
        new Object[]{"Customer#000000089", "89", "6882", "1997-04-09", 389430.93D, 303L}
    );
  }


  @Test
  public void tpch19() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "SELECT\n"
        + "    SUM(L_EXTENDEDPRICE* (1 - L_DISCOUNT)) AS REVENUE\n"
        + " FROM\n"
        + "    lineitem,\n"
        + "    part\n"
        + " WHERE\n"
        + "    (\n"
        + "        P_PARTKEY = L_PARTKEY\n"
        + "        AND P_BRAND = 'Brand#32'\n"
        + "        AND P_CONTAINER IN ('SM CASE', 'SM BOX', 'SM PACK', 'SM PKG')\n"
        + "        AND L_QUANTITY >= 7 AND L_QUANTITY <= 7 + 10\n"
        + "        AND P_SIZE BETWEEN 1 AND 5\n"
        + "        AND L_SHIPMODE IN ('AIR', 'AIR REG')\n"
        + "        AND L_SHIPINSTRUCT = 'DELIVER IN PERSON'\n"
        + "    )\n"
        + "    OR\n"
        + "    (\n"
        + "        P_PARTKEY = L_PARTKEY\n"
        + "        AND P_BRAND = 'Brand#35'\n"
        + "        AND P_CONTAINER IN ('MED BAG', 'MED BOX', 'MED PKG', 'MED PACK')\n"
        + "        AND L_QUANTITY >= 15 AND L_QUANTITY <= 15 + 10\n"
        + "        AND P_SIZE BETWEEN 1 AND 10\n"
        + "        AND L_SHIPMODE IN ('AIR', 'AIR REG')\n"
        + "        AND L_SHIPINSTRUCT = 'DELIVER IN PERSON'\n"
        + "    )\n"
        + "    OR\n"
        + "    (\n"
        + "        P_PARTKEY = L_PARTKEY\n"
        + "        AND P_BRAND = 'Brand#24'\n"
        + "        AND P_CONTAINER IN ('LG CASE', 'LG BOX', 'LG PACK', 'LG PKG')\n"
        + "        AND L_QUANTITY >= 26 AND L_QUANTITY <= 26 + 10\n"
        + "        AND P_SIZE BETWEEN 1 AND 15\n"
        + "        AND L_SHIPMODE IN ('AIR', 'AIR REG')\n"
        + "        AND L_SHIPINSTRUCT = 'DELIVER IN PERSON'\n"
        + "    )",
        "{\n"
        + "  \"queryType\" : \"timeseries\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"lineitem\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"L_DISCOUNT\", \"L_EXTENDEDPRICE\", \"L_PARTKEY\", \"L_QUANTITY\", \"L_SHIPINSTRUCT\", \"L_SHIPMODE\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"part\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"part\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"P_BRAND\", \"P_CONTAINER\", \"P_PARTKEY\", \"P_SIZE\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"lineitem\",\n"
        + "        \"leftJoinColumns\" : [ \"L_PARTKEY\" ],\n"
        + "        \"rightAlias\" : \"part\",\n"
        + "        \"rightJoinColumns\" : [ \"P_PARTKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false,\n"
        + "        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"lineitem\", \"part\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"descending\" : false,\n"
        + "  \"filter\" : {\n"
        + "    \"type\" : \"and\",\n"
        + "    \"fields\" : [ {\n"
        + "      \"type\" : \"bound\",\n"
        + "      \"dimension\" : \"P_SIZE\",\n"
        + "      \"lower\" : \"1\",\n"
        + "      \"lowerStrict\" : false,\n"
        + "      \"upperStrict\" : false,\n"
        + "      \"comparatorType\" : \"numeric\"\n"
        + "    }, {\n"
        + "      \"type\" : \"in\",\n"
        + "      \"dimension\" : \"L_SHIPMODE\",\n"
        + "      \"values\" : [ \"AIR\", \"AIR REG\" ]\n"
        + "    }, {\n"
        + "      \"type\" : \"selector\",\n"
        + "      \"dimension\" : \"L_SHIPINSTRUCT\",\n"
        + "      \"value\" : \"DELIVER IN PERSON\"\n"
        + "    }, {\n"
        + "      \"type\" : \"or\",\n"
        + "      \"fields\" : [ {\n"
        + "        \"type\" : \"and\",\n"
        + "        \"fields\" : [ {\n"
        + "          \"type\" : \"selector\",\n"
        + "          \"dimension\" : \"P_BRAND\",\n"
        + "          \"value\" : \"Brand#32\"\n"
        + "        }, {\n"
        + "          \"type\" : \"in\",\n"
        + "          \"dimension\" : \"P_CONTAINER\",\n"
        + "          \"values\" : [ \"SM BOX\", \"SM CASE\", \"SM PACK\", \"SM PKG\" ]\n"
        + "        }, {\n"
        + "          \"type\" : \"bound\",\n"
        + "          \"dimension\" : \"P_SIZE\",\n"
        + "          \"upper\" : \"5\",\n"
        + "          \"lowerStrict\" : false,\n"
        + "          \"upperStrict\" : false,\n"
        + "          \"comparatorType\" : \"numeric\"\n"
        + "        }, {\n"
        + "          \"type\" : \"bound\",\n"
        + "          \"dimension\" : \"L_QUANTITY\",\n"
        + "          \"lower\" : \"7\",\n"
        + "          \"upper\" : \"17\",\n"
        + "          \"lowerStrict\" : false,\n"
        + "          \"upperStrict\" : false,\n"
        + "          \"comparatorType\" : \"numeric\"\n"
        + "        } ]\n"
        + "      }, {\n"
        + "        \"type\" : \"and\",\n"
        + "        \"fields\" : [ {\n"
        + "          \"type\" : \"selector\",\n"
        + "          \"dimension\" : \"P_BRAND\",\n"
        + "          \"value\" : \"Brand#35\"\n"
        + "        }, {\n"
        + "          \"type\" : \"in\",\n"
        + "          \"dimension\" : \"P_CONTAINER\",\n"
        + "          \"values\" : [ \"MED BAG\", \"MED BOX\", \"MED PACK\", \"MED PKG\" ]\n"
        + "        }, {\n"
        + "          \"type\" : \"bound\",\n"
        + "          \"dimension\" : \"P_SIZE\",\n"
        + "          \"upper\" : \"10\",\n"
        + "          \"lowerStrict\" : false,\n"
        + "          \"upperStrict\" : false,\n"
        + "          \"comparatorType\" : \"numeric\"\n"
        + "        }, {\n"
        + "          \"type\" : \"bound\",\n"
        + "          \"dimension\" : \"L_QUANTITY\",\n"
        + "          \"lower\" : \"15\",\n"
        + "          \"upper\" : \"25\",\n"
        + "          \"lowerStrict\" : false,\n"
        + "          \"upperStrict\" : false,\n"
        + "          \"comparatorType\" : \"numeric\"\n"
        + "        } ]\n"
        + "      }, {\n"
        + "        \"type\" : \"and\",\n"
        + "        \"fields\" : [ {\n"
        + "          \"type\" : \"selector\",\n"
        + "          \"dimension\" : \"P_BRAND\",\n"
        + "          \"value\" : \"Brand#24\"\n"
        + "        }, {\n"
        + "          \"type\" : \"in\",\n"
        + "          \"dimension\" : \"P_CONTAINER\",\n"
        + "          \"values\" : [ \"LG BOX\", \"LG CASE\", \"LG PACK\", \"LG PKG\" ]\n"
        + "        }, {\n"
        + "          \"type\" : \"bound\",\n"
        + "          \"dimension\" : \"P_SIZE\",\n"
        + "          \"upper\" : \"15\",\n"
        + "          \"lowerStrict\" : false,\n"
        + "          \"upperStrict\" : false,\n"
        + "          \"comparatorType\" : \"numeric\"\n"
        + "        }, {\n"
        + "          \"type\" : \"bound\",\n"
        + "          \"dimension\" : \"L_QUANTITY\",\n"
        + "          \"lower\" : \"26\",\n"
        + "          \"upper\" : \"36\",\n"
        + "          \"lowerStrict\" : false,\n"
        + "          \"upperStrict\" : false,\n"
        + "          \"comparatorType\" : \"numeric\"\n"
        + "        } ]\n"
        + "      } ]\n"
        + "    } ]\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"a0\",\n"
        + "    \"fieldExpression\" : \"(\\\"L_EXTENDEDPRICE\\\" * (1 - \\\"L_DISCOUNT\\\"))\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"noop\"\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false,\n"
        + "    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "  }\n"
        + "}"
    );
  }

  @Test
  public void tpch20() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH TMP1 AS (\n"
        + "SELECT P_PARTKEY FROM part WHERE P_NAME LIKE 'forest%'\n"
        + "),\n"
        + "TMP2 AS (\n"
        + "SELECT S_NAME, S_ADDRESS, S_SUPPKEY\n"
        + " FROM supplier, nation\n"
        + " WHERE S_NATIONKEY = N_NATIONKEY\n"
        + " AND N_NAME = 'CANADA'\n"
        + "),\n"
        + "TMP3 AS (\n"
        + "SELECT L_PARTKEY, 0.5 * SUM(L_QUANTITY) AS SUM_QUANTITY, L_SUPPKEY\n"
        + " FROM lineitem, TMP2\n"
        + " WHERE L_SHIPDATE >= '1994-01-01' AND L_SHIPDATE <= '1995-01-01'\n"
        + " AND L_SUPPKEY = S_SUPPKEY\n"
        + " GROUP BY L_PARTKEY, L_SUPPKEY\n"
        + "),\n"
        + "TMP4 AS (\n"
        + "SELECT PS_PARTKEY, PS_SUPPKEY, PS_AVAILQTY\n"
        + " FROM partsupp\n"
        + " WHERE PS_PARTKEY IN (SELECT P_PARTKEY FROM TMP1)\n"
        + "),\n"
        + "TMP5 AS (\n"
        + "SELECT\n"
        + "    PS_SUPPKEY\n"
        + " FROM\n"
        + "    TMP4, TMP3\n"
        + " WHERE\n"
        + "    PS_PARTKEY = L_PARTKEY\n"
        + " AND PS_SUPPKEY = L_SUPPKEY\n"
        + " AND PS_AVAILQTY > SUM_QUANTITY\n"
        + ")\n"
        + "SELECT\n"
        + "    S_NAME,\n"
        + "    S_ADDRESS\n"
        + " FROM\n"
        + "    supplier\n"
        + " WHERE\n"
        + "    S_SUPPKEY IN (SELECT PS_SUPPKEY FROM TMP5)\n"
        + " ORDER BY S_NAME",
        "{\n"
        + "  \"queryType\" : \"select.stream\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"partsupp+part+lineitem+supplier+nation\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"groupBy\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"partsupp+part\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"query\",\n"
        + "                        \"query\" : {\n"
        + "                          \"queryType\" : \"join\",\n"
        + "                          \"dataSources\" : {\n"
        + "                            \"partsupp\" : {\n"
        + "                              \"type\" : \"query\",\n"
        + "                              \"query\" : {\n"
        + "                                \"queryType\" : \"select.stream\",\n"
        + "                                \"dataSource\" : {\n"
        + "                                  \"type\" : \"table\",\n"
        + "                                  \"name\" : \"partsupp\"\n"
        + "                                },\n"
        + "                                \"descending\" : false,\n"
        + "                                \"columns\" : [ \"PS_AVAILQTY\", \"PS_PARTKEY\", \"PS_SUPPKEY\" ],\n"
        + "                                \"limitSpec\" : {\n"
        + "                                  \"type\" : \"noop\"\n"
        + "                                },\n"
        + "                                \"context\" : {\n"
        + "                                  \"groupby.sort.on.time\" : false,\n"
        + "                                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                }\n"
        + "                              }\n"
        + "                            },\n"
        + "                            \"part\" : {\n"
        + "                              \"type\" : \"query\",\n"
        + "                              \"query\" : {\n"
        + "                                \"queryType\" : \"groupBy\",\n"
        + "                                \"dataSource\" : {\n"
        + "                                  \"type\" : \"table\",\n"
        + "                                  \"name\" : \"part\"\n"
        + "                                },\n"
        + "                                \"filter\" : {\n"
        + "                                  \"type\" : \"like\",\n"
        + "                                  \"dimension\" : \"P_NAME\",\n"
        + "                                  \"pattern\" : \"forest%\"\n"
        + "                                },\n"
        + "                                \"granularity\" : {\n"
        + "                                  \"type\" : \"all\"\n"
        + "                                },\n"
        + "                                \"dimensions\" : [ {\n"
        + "                                  \"type\" : \"default\",\n"
        + "                                  \"dimension\" : \"P_PARTKEY\",\n"
        + "                                  \"outputName\" : \"d0\"\n"
        + "                                } ],\n"
        + "                                \"limitSpec\" : {\n"
        + "                                  \"type\" : \"noop\"\n"
        + "                                },\n"
        + "                                \"outputColumns\" : [ \"d0\" ],\n"
        + "                                \"context\" : {\n"
        + "                                  \"groupby.sort.on.time\" : false,\n"
        + "                                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                },\n"
        + "                                \"descending\" : false\n"
        + "                              }\n"
        + "                            }\n"
        + "                          },\n"
        + "                          \"elements\" : [ {\n"
        + "                            \"joinType\" : \"INNER\",\n"
        + "                            \"leftAlias\" : \"partsupp\",\n"
        + "                            \"leftJoinColumns\" : [ \"PS_PARTKEY\" ],\n"
        + "                            \"rightAlias\" : \"part\",\n"
        + "                            \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "                          } ],\n"
        + "                          \"prefixAlias\" : false,\n"
        + "                          \"asArray\" : true,\n"
        + "                          \"limit\" : 0,\n"
        + "                          \"context\" : {\n"
        + "                            \"groupby.sort.on.time\" : false,\n"
        + "                            \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                          },\n"
        + "                          \"dataSource\" : {\n"
        + "                            \"type\" : \"union\",\n"
        + "                            \"dataSources\" : [ \"partsupp\", \"part\" ]\n"
        + "                          },\n"
        + "                          \"descending\" : false\n"
        + "                        }\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"columns\" : [ \"PS_PARTKEY\", \"PS_SUPPKEY\", \"PS_AVAILQTY\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"lineitem+supplier+nation\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"groupBy\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"query\",\n"
        + "                        \"query\" : {\n"
        + "                          \"queryType\" : \"join\",\n"
        + "                          \"dataSources\" : {\n"
        + "                            \"supplier+nation\" : {\n"
        + "                              \"type\" : \"query\",\n"
        + "                              \"query\" : {\n"
        + "                                \"queryType\" : \"select.stream\",\n"
        + "                                \"dataSource\" : {\n"
        + "                                  \"type\" : \"query\",\n"
        + "                                  \"query\" : {\n"
        + "                                    \"queryType\" : \"join\",\n"
        + "                                    \"dataSources\" : {\n"
        + "                                      \"nation\" : {\n"
        + "                                        \"type\" : \"query\",\n"
        + "                                        \"query\" : {\n"
        + "                                          \"queryType\" : \"select.stream\",\n"
        + "                                          \"dataSource\" : {\n"
        + "                                            \"type\" : \"table\",\n"
        + "                                            \"name\" : \"nation\"\n"
        + "                                          },\n"
        + "                                          \"descending\" : false,\n"
        + "                                          \"filter\" : {\n"
        + "                                            \"type\" : \"selector\",\n"
        + "                                            \"dimension\" : \"N_NAME\",\n"
        + "                                            \"value\" : \"CANADA\"\n"
        + "                                          },\n"
        + "                                          \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "                                          \"limitSpec\" : {\n"
        + "                                            \"type\" : \"noop\"\n"
        + "                                          },\n"
        + "                                          \"context\" : {\n"
        + "                                            \"groupby.sort.on.time\" : false,\n"
        + "                                            \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                          }\n"
        + "                                        }\n"
        + "                                      },\n"
        + "                                      \"supplier\" : {\n"
        + "                                        \"type\" : \"query\",\n"
        + "                                        \"query\" : {\n"
        + "                                          \"queryType\" : \"select.stream\",\n"
        + "                                          \"dataSource\" : {\n"
        + "                                            \"type\" : \"table\",\n"
        + "                                            \"name\" : \"supplier\"\n"
        + "                                          },\n"
        + "                                          \"descending\" : false,\n"
        + "                                          \"columns\" : [ \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                                          \"limitSpec\" : {\n"
        + "                                            \"type\" : \"noop\"\n"
        + "                                          },\n"
        + "                                          \"context\" : {\n"
        + "                                            \"groupby.sort.on.time\" : false,\n"
        + "                                            \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                          }\n"
        + "                                        }\n"
        + "                                      }\n"
        + "                                    },\n"
        + "                                    \"elements\" : [ {\n"
        + "                                      \"joinType\" : \"INNER\",\n"
        + "                                      \"leftAlias\" : \"supplier\",\n"
        + "                                      \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "                                      \"rightAlias\" : \"nation\",\n"
        + "                                      \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "                                    } ],\n"
        + "                                    \"prefixAlias\" : false,\n"
        + "                                    \"asArray\" : true,\n"
        + "                                    \"limit\" : 0,\n"
        + "                                    \"context\" : {\n"
        + "                                      \"groupby.sort.on.time\" : false,\n"
        + "                                      \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                    },\n"
        + "                                    \"dataSource\" : {\n"
        + "                                      \"type\" : \"union\",\n"
        + "                                      \"dataSources\" : [ \"supplier\", \"nation\" ]\n"
        + "                                    },\n"
        + "                                    \"descending\" : false\n"
        + "                                  }\n"
        + "                                },\n"
        + "                                \"descending\" : false,\n"
        + "                                \"columns\" : [ \"S_SUPPKEY\" ],\n"
        + "                                \"limitSpec\" : {\n"
        + "                                  \"type\" : \"noop\"\n"
        + "                                },\n"
        + "                                \"context\" : {\n"
        + "                                  \"groupby.sort.on.time\" : false,\n"
        + "                                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                }\n"
        + "                              }\n"
        + "                            },\n"
        + "                            \"lineitem\" : {\n"
        + "                              \"type\" : \"query\",\n"
        + "                              \"query\" : {\n"
        + "                                \"queryType\" : \"select.stream\",\n"
        + "                                \"dataSource\" : {\n"
        + "                                  \"type\" : \"table\",\n"
        + "                                  \"name\" : \"lineitem\"\n"
        + "                                },\n"
        + "                                \"descending\" : false,\n"
        + "                                \"filter\" : {\n"
        + "                                  \"type\" : \"bound\",\n"
        + "                                  \"dimension\" : \"L_SHIPDATE\",\n"
        + "                                  \"lower\" : \"1994-01-01\",\n"
        + "                                  \"upper\" : \"1995-01-01\",\n"
        + "                                  \"lowerStrict\" : false,\n"
        + "                                  \"upperStrict\" : false,\n"
        + "                                  \"comparatorType\" : \"lexicographic\"\n"
        + "                                },\n"
        + "                                \"columns\" : [ \"L_PARTKEY\", \"L_QUANTITY\", \"L_SHIPDATE\", \"L_SUPPKEY\" ],\n"
        + "                                \"limitSpec\" : {\n"
        + "                                  \"type\" : \"noop\"\n"
        + "                                },\n"
        + "                                \"context\" : {\n"
        + "                                  \"groupby.sort.on.time\" : false,\n"
        + "                                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                }\n"
        + "                              }\n"
        + "                            }\n"
        + "                          },\n"
        + "                          \"elements\" : [ {\n"
        + "                            \"joinType\" : \"INNER\",\n"
        + "                            \"leftAlias\" : \"lineitem\",\n"
        + "                            \"leftJoinColumns\" : [ \"L_SUPPKEY\" ],\n"
        + "                            \"rightAlias\" : \"supplier+nation\",\n"
        + "                            \"rightJoinColumns\" : [ \"S_SUPPKEY\" ]\n"
        + "                          } ],\n"
        + "                          \"prefixAlias\" : false,\n"
        + "                          \"asArray\" : true,\n"
        + "                          \"limit\" : 0,\n"
        + "                          \"context\" : {\n"
        + "                            \"groupby.sort.on.time\" : false,\n"
        + "                            \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                          },\n"
        + "                          \"dataSource\" : {\n"
        + "                            \"type\" : \"union\",\n"
        + "                            \"dataSources\" : [ \"lineitem\", \"supplier+nation\" ]\n"
        + "                          },\n"
        + "                          \"descending\" : false\n"
        + "                        }\n"
        + "                      },\n"
        + "                      \"granularity\" : {\n"
        + "                        \"type\" : \"all\"\n"
        + "                      },\n"
        + "                      \"dimensions\" : [ {\n"
        + "                        \"type\" : \"default\",\n"
        + "                        \"dimension\" : \"L_PARTKEY\",\n"
        + "                        \"outputName\" : \"d0\"\n"
        + "                      }, {\n"
        + "                        \"type\" : \"default\",\n"
        + "                        \"dimension\" : \"L_SUPPKEY\",\n"
        + "                        \"outputName\" : \"d1\"\n"
        + "                      } ],\n"
        + "                      \"aggregations\" : [ {\n"
        + "                        \"type\" : \"sum\",\n"
        + "                        \"name\" : \"a0\",\n"
        + "                        \"fieldName\" : \"L_QUANTITY\",\n"
        + "                        \"inputType\" : \"long\"\n"
        + "                      } ],\n"
        + "                      \"postAggregations\" : [ {\n"
        + "                        \"type\" : \"math\",\n"
        + "                        \"name\" : \"p0\",\n"
        + "                        \"expression\" : \"(0.5B * \\\"a0\\\")\",\n"
        + "                        \"finalize\" : true\n"
        + "                      } ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"outputColumns\" : [ \"d0\", \"p0\", \"d1\" ],\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      },\n"
        + "                      \"descending\" : false\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"INNER\",\n"
        + "                  \"leftAlias\" : \"partsupp+part\",\n"
        + "                  \"leftJoinColumns\" : [ \"PS_PARTKEY\", \"PS_SUPPKEY\" ],\n"
        + "                  \"rightAlias\" : \"lineitem+supplier+nation\",\n"
        + "                  \"rightJoinColumns\" : [ \"d0\", \"d1\" ]\n"
        + "                } ],\n"
        + "                \"prefixAlias\" : false,\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false,\n"
        + "                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                },\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"partsupp+part\", \"lineitem+supplier+nation\" ]\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"math\",\n"
        + "              \"expression\" : \"(\\\"PS_AVAILQTY\\\" > \\\"p0\\\")\"\n"
        + "            },\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"dimensions\" : [ {\n"
        + "              \"type\" : \"default\",\n"
        + "              \"dimension\" : \"PS_SUPPKEY\",\n"
        + "              \"outputName\" : \"_d0\"\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"_d0\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        },\n"
        + "        \"supplier\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"supplier\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"S_ADDRESS\", \"S_NAME\", \"S_SUPPKEY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"supplier\",\n"
        + "        \"leftJoinColumns\" : [ \"S_SUPPKEY\" ],\n"
        + "        \"rightAlias\" : \"partsupp+part+lineitem+supplier+nation\",\n"
        + "        \"rightJoinColumns\" : [ \"_d0\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false,\n"
        + "        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"supplier\", \"partsupp+part+lineitem+supplier+nation\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"descending\" : false,\n"
        + "  \"columns\" : [ \"S_NAME\", \"S_ADDRESS\" ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"S_NAME\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false,\n"
        + "    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "  }\n"
        + "}"
    );
  }

  @Test
  public void tpch21() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH LOCATION AS (\n"
        + " SELECT supplier.* FROM supplier, nation WHERE\n"
        + " S_NATIONKEY = N_NATIONKEY AND N_NAME = 'SAUDI ARABIA'\n"
        + "),\n"
        + "L3 AS (\n"
        + "SELECT L_ORDERKEY, COUNT(DISTINCT L_SUPPKEY) AS CNTSUPP\n"
        + " FROM lineitem\n"
        + " WHERE L_RECEIPTDATE > L_COMMITDATE AND L_ORDERKEY IS NOT NULL\n"
        + " GROUP BY L_ORDERKEY\n"
        + " HAVING CNTSUPP = 1\n"
        + ")\n"
        + "SELECT S_NAME, COUNT(*) AS NUMWAIT FROM\n"
        + "(\n"
        + " SELECT LI.L_SUPPKEY, LI.L_ORDERKEY\n"
        + " FROM lineitem LI JOIN orders O ON LI.L_ORDERKEY = O.O_ORDERKEY AND O.O_ORDERSTATUS = 'F'\n"
        + "     JOIN\n"
        + "     (\n"
        + "       SELECT L_ORDERKEY, COUNT(DISTINCT L_SUPPKEY) AS CNTSUPP\n"
        + "       FROM lineitem\n"
        + "       GROUP BY L_ORDERKEY\n"
        + "     ) L2 ON LI.L_ORDERKEY = L2.L_ORDERKEY AND\n"
        + "             LI.L_RECEIPTDATE > LI.L_COMMITDATE AND\n"
        + "             L2.CNTSUPP > 1\n"
        + ") L1 JOIN L3 ON L1.L_ORDERKEY = L3.L_ORDERKEY\n"
        + " JOIN LOCATION S ON L1.L_SUPPKEY = S.S_SUPPKEY\n"
        + " GROUP BY S_NAME\n"
        + " ORDER BY NUMWAIT DESC, S_NAME\n"
        + " LIMIT 100",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"supplier+nation\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"nation\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"nation\"\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"filter\" : {\n"
        + "                        \"type\" : \"selector\",\n"
        + "                        \"dimension\" : \"N_NAME\",\n"
        + "                        \"value\" : \"SAUDI ARABIA\"\n"
        + "                      },\n"
        + "                      \"columns\" : [ \"N_NAME\", \"N_NATIONKEY\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      }\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"supplier\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"supplier\"\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"columns\" : [ \"S_NAME\", \"S_NATIONKEY\", \"S_SUPPKEY\" ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      }\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"INNER\",\n"
        + "                  \"leftAlias\" : \"supplier\",\n"
        + "                  \"leftJoinColumns\" : [ \"S_NATIONKEY\" ],\n"
        + "                  \"rightAlias\" : \"nation\",\n"
        + "                  \"rightJoinColumns\" : [ \"N_NATIONKEY\" ]\n"
        + "                } ],\n"
        + "                \"prefixAlias\" : false,\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false,\n"
        + "                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                },\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"supplier\", \"nation\" ]\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"columns\" : [ \"S_NAME\", \"S_SUPPKEY\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"orders+lineitem+lineitem+lineitem\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"join\",\n"
        + "            \"dataSources\" : {\n"
        + "              \"lineitem\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"groupBy\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"table\",\n"
        + "                    \"name\" : \"lineitem\"\n"
        + "                  },\n"
        + "                  \"filter\" : {\n"
        + "                    \"type\" : \"and\",\n"
        + "                    \"fields\" : [ {\n"
        + "                      \"type\" : \"math\",\n"
        + "                      \"expression\" : \"(\\\"L_RECEIPTDATE\\\" > \\\"L_COMMITDATE\\\")\"\n"
        + "                    }, {\n"
        + "                      \"type\" : \"not\",\n"
        + "                      \"field\" : {\n"
        + "                        \"type\" : \"selector\",\n"
        + "                        \"dimension\" : \"L_ORDERKEY\",\n"
        + "                        \"value\" : \"\"\n"
        + "                      }\n"
        + "                    } ]\n"
        + "                  },\n"
        + "                  \"granularity\" : {\n"
        + "                    \"type\" : \"all\"\n"
        + "                  },\n"
        + "                  \"dimensions\" : [ {\n"
        + "                    \"type\" : \"default\",\n"
        + "                    \"dimension\" : \"L_ORDERKEY\",\n"
        + "                    \"outputName\" : \"d0\"\n"
        + "                  } ],\n"
        + "                  \"aggregations\" : [ {\n"
        + "                    \"type\" : \"cardinality\",\n"
        + "                    \"name\" : \"a0:a\",\n"
        + "                    \"fields\" : [ {\n"
        + "                      \"type\" : \"default\",\n"
        + "                      \"dimension\" : \"L_SUPPKEY\",\n"
        + "                      \"outputName\" : \"L_SUPPKEY\"\n"
        + "                    } ],\n"
        + "                    \"byRow\" : false,\n"
        + "                    \"round\" : true\n"
        + "                  } ],\n"
        + "                  \"postAggregations\" : [ {\n"
        + "                    \"type\" : \"hyperUniqueCardinality\",\n"
        + "                    \"name\" : \"a0\",\n"
        + "                    \"fieldName\" : \"a0:a\",\n"
        + "                    \"round\" : true\n"
        + "                  } ],\n"
        + "                  \"having\" : {\n"
        + "                    \"type\" : \"expression\",\n"
        + "                    \"expression\" : \"(\\\"a0\\\" == 1)\"\n"
        + "                  },\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false,\n"
        + "                    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                  },\n"
        + "                  \"descending\" : false\n"
        + "                }\n"
        + "              },\n"
        + "              \"orders+lineitem+lineitem\" : {\n"
        + "                \"type\" : \"query\",\n"
        + "                \"query\" : {\n"
        + "                  \"queryType\" : \"select.stream\",\n"
        + "                  \"dataSource\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"join\",\n"
        + "                      \"dataSources\" : {\n"
        + "                        \"lineitem\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"groupBy\",\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"table\",\n"
        + "                              \"name\" : \"lineitem\"\n"
        + "                            },\n"
        + "                            \"granularity\" : {\n"
        + "                              \"type\" : \"all\"\n"
        + "                            },\n"
        + "                            \"dimensions\" : [ {\n"
        + "                              \"type\" : \"default\",\n"
        + "                              \"dimension\" : \"L_ORDERKEY\",\n"
        + "                              \"outputName\" : \"d0\"\n"
        + "                            } ],\n"
        + "                            \"aggregations\" : [ {\n"
        + "                              \"type\" : \"cardinality\",\n"
        + "                              \"name\" : \"a0:a\",\n"
        + "                              \"fields\" : [ {\n"
        + "                                \"type\" : \"default\",\n"
        + "                                \"dimension\" : \"L_SUPPKEY\",\n"
        + "                                \"outputName\" : \"L_SUPPKEY\"\n"
        + "                              } ],\n"
        + "                              \"byRow\" : false,\n"
        + "                              \"round\" : true\n"
        + "                            } ],\n"
        + "                            \"postAggregations\" : [ {\n"
        + "                              \"type\" : \"hyperUniqueCardinality\",\n"
        + "                              \"name\" : \"a0\",\n"
        + "                              \"fieldName\" : \"a0:a\",\n"
        + "                              \"round\" : true\n"
        + "                            } ],\n"
        + "                            \"having\" : {\n"
        + "                              \"type\" : \"expression\",\n"
        + "                              \"expression\" : \"(\\\"a0\\\" > 1)\"\n"
        + "                            },\n"
        + "                            \"limitSpec\" : {\n"
        + "                              \"type\" : \"noop\"\n"
        + "                            },\n"
        + "                            \"outputColumns\" : [ \"d0\", \"a0\" ],\n"
        + "                            \"context\" : {\n"
        + "                              \"groupby.sort.on.time\" : false,\n"
        + "                              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                            },\n"
        + "                            \"descending\" : false\n"
        + "                          }\n"
        + "                        },\n"
        + "                        \"orders+lineitem\" : {\n"
        + "                          \"type\" : \"query\",\n"
        + "                          \"query\" : {\n"
        + "                            \"queryType\" : \"join\",\n"
        + "                            \"dataSources\" : {\n"
        + "                              \"lineitem\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"select.stream\",\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"table\",\n"
        + "                                    \"name\" : \"lineitem\"\n"
        + "                                  },\n"
        + "                                  \"descending\" : false,\n"
        + "                                  \"filter\" : {\n"
        + "                                    \"type\" : \"math\",\n"
        + "                                    \"expression\" : \"(\\\"L_RECEIPTDATE\\\" > \\\"L_COMMITDATE\\\")\"\n"
        + "                                  },\n"
        + "                                  \"columns\" : [ \"L_COMMITDATE\", \"L_ORDERKEY\", \"L_RECEIPTDATE\", \"L_SUPPKEY\" ],\n"
        + "                                  \"limitSpec\" : {\n"
        + "                                    \"type\" : \"noop\"\n"
        + "                                  },\n"
        + "                                  \"context\" : {\n"
        + "                                    \"groupby.sort.on.time\" : false,\n"
        + "                                    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              },\n"
        + "                              \"orders\" : {\n"
        + "                                \"type\" : \"query\",\n"
        + "                                \"query\" : {\n"
        + "                                  \"queryType\" : \"select.stream\",\n"
        + "                                  \"dataSource\" : {\n"
        + "                                    \"type\" : \"table\",\n"
        + "                                    \"name\" : \"orders\"\n"
        + "                                  },\n"
        + "                                  \"descending\" : false,\n"
        + "                                  \"filter\" : {\n"
        + "                                    \"type\" : \"selector\",\n"
        + "                                    \"dimension\" : \"O_ORDERSTATUS\",\n"
        + "                                    \"value\" : \"F\"\n"
        + "                                  },\n"
        + "                                  \"columns\" : [ \"O_ORDERKEY\", \"O_ORDERSTATUS\" ],\n"
        + "                                  \"limitSpec\" : {\n"
        + "                                    \"type\" : \"noop\"\n"
        + "                                  },\n"
        + "                                  \"context\" : {\n"
        + "                                    \"groupby.sort.on.time\" : false,\n"
        + "                                    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                                  }\n"
        + "                                }\n"
        + "                              }\n"
        + "                            },\n"
        + "                            \"elements\" : [ {\n"
        + "                              \"joinType\" : \"INNER\",\n"
        + "                              \"leftAlias\" : \"orders\",\n"
        + "                              \"leftJoinColumns\" : [ \"O_ORDERKEY\" ],\n"
        + "                              \"rightAlias\" : \"lineitem\",\n"
        + "                              \"rightJoinColumns\" : [ \"L_ORDERKEY\" ]\n"
        + "                            } ],\n"
        + "                            \"prefixAlias\" : false,\n"
        + "                            \"asArray\" : true,\n"
        + "                            \"limit\" : 0,\n"
        + "                            \"context\" : {\n"
        + "                              \"groupby.sort.on.time\" : false,\n"
        + "                              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                            },\n"
        + "                            \"dataSource\" : {\n"
        + "                              \"type\" : \"union\",\n"
        + "                              \"dataSources\" : [ \"orders\", \"lineitem\" ]\n"
        + "                            },\n"
        + "                            \"descending\" : false\n"
        + "                          }\n"
        + "                        }\n"
        + "                      },\n"
        + "                      \"elements\" : [ {\n"
        + "                        \"joinType\" : \"INNER\",\n"
        + "                        \"leftAlias\" : \"orders+lineitem\",\n"
        + "                        \"leftJoinColumns\" : [ \"L_ORDERKEY\" ],\n"
        + "                        \"rightAlias\" : \"lineitem\",\n"
        + "                        \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "                      } ],\n"
        + "                      \"prefixAlias\" : false,\n"
        + "                      \"asArray\" : true,\n"
        + "                      \"limit\" : 0,\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      },\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"union\",\n"
        + "                        \"dataSources\" : [ \"orders+lineitem\", \"lineitem\" ]\n"
        + "                      },\n"
        + "                      \"descending\" : false\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"descending\" : false,\n"
        + "                  \"columns\" : [ \"L_SUPPKEY\", \"L_ORDERKEY\" ],\n"
        + "                  \"limitSpec\" : {\n"
        + "                    \"type\" : \"noop\"\n"
        + "                  },\n"
        + "                  \"context\" : {\n"
        + "                    \"groupby.sort.on.time\" : false,\n"
        + "                    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                  }\n"
        + "                }\n"
        + "              }\n"
        + "            },\n"
        + "            \"elements\" : [ {\n"
        + "              \"joinType\" : \"INNER\",\n"
        + "              \"leftAlias\" : \"orders+lineitem+lineitem\",\n"
        + "              \"leftJoinColumns\" : [ \"L_ORDERKEY\" ],\n"
        + "              \"rightAlias\" : \"lineitem\",\n"
        + "              \"rightJoinColumns\" : [ \"d0\" ]\n"
        + "            } ],\n"
        + "            \"prefixAlias\" : false,\n"
        + "            \"asArray\" : true,\n"
        + "            \"limit\" : 0,\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            },\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"union\",\n"
        + "              \"dataSources\" : [ \"orders+lineitem+lineitem\", \"lineitem\" ]\n"
        + "            },\n"
        + "            \"descending\" : false\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"orders+lineitem+lineitem+lineitem\",\n"
        + "        \"leftJoinColumns\" : [ \"L_SUPPKEY\" ],\n"
        + "        \"rightAlias\" : \"supplier+nation\",\n"
        + "        \"rightJoinColumns\" : [ \"S_SUPPKEY\" ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false,\n"
        + "        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"orders+lineitem+lineitem+lineitem\", \"supplier+nation\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"S_NAME\",\n"
        + "    \"outputName\" : \"_d0\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"count\",\n"
        + "    \"name\" : \"_a0\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"descending\",\n"
        + "      \"dimension\" : \"_a0\"\n"
        + "    }, {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"_d0\"\n"
        + "    } ],\n"
        + "    \"limit\" : 100\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"_d0\", \"_a0\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false,\n"
        + "    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}"
    );
  }

  @Test
  public void tpch22() throws Exception
  {
    testQuery(
        PLANNER_CONFIG_JOIN_ENABLED,
        "WITH q22_customer_tmp_cached AS (\n"
        + " SELECT\n"
        + "    C_ACCTBAL,\n"
        + "    C_CUSTKEY,\n"
        + "    SUBSTR(C_PHONE, 1, 2) AS CNTRYCODE\n"
        + " FROM\n"
        + "    customer\n"
        + " WHERE\n"
        + "    SUBSTR(C_PHONE, 1, 2) = '13' OR\n"
        + "    SUBSTR(C_PHONE, 1, 2) = '31' OR\n"
        + "    SUBSTR(C_PHONE, 1, 2) = '23' OR\n"
        + "    SUBSTR(C_PHONE, 1, 2) = '29' OR\n"
        + "    SUBSTR(C_PHONE, 1, 2) = '30' OR\n"
        + "    SUBSTR(C_PHONE, 1, 2) = '18' OR\n"
        + "    SUBSTR(C_PHONE, 1, 2) = '17'\n"
        + "),\n"
        + "q22_customer_tmp1_cached AS (\n"
        + " SELECT\n"
        + "    AVG(C_ACCTBAL) AS AVG_ACCTBAL\n"
        + " FROM\n"
        + "    q22_customer_tmp_cached\n"
        + " WHERE\n"
        + "    C_ACCTBAL > 0.00\n"
        + "),\n"
        + "q22_orders_tmp_cached AS (\n"
        + " SELECT\n"
        + "    O_CUSTKEY\n"
        + " FROM\n"
        + "    orders\n"
        + " GROUP BY\n"
        + "    O_CUSTKEY\n"
        + ")\n"
        + "SELECT\n"
        + "    CNTRYCODE,\n"
        + "    COUNT(1) AS NUMCUST,\n"
        + "    SUM(C_ACCTBAL) AS TOTACCTBAL\n"
        + " FROM (\n"
        + "    SELECT\n"
        + "        CNTRYCODE,\n"
        + "        C_ACCTBAL,\n"
        + "        AVG_ACCTBAL\n"
        + "    FROM\n"
        + "        q22_customer_tmp1_cached CT1 CROSS JOIN (\n"
        + "            SELECT\n"
        + "                CNTRYCODE,\n"
        + "                C_ACCTBAL\n"
        + "            FROM\n"
        + "                q22_orders_tmp_cached OT\n"
        + "                RIGHT OUTER JOIN q22_customer_tmp_cached CT\n"
        + "                ON CT.C_CUSTKEY = OT.O_CUSTKEY\n"
        + "            WHERE\n"
        + "                O_CUSTKEY IS NULL\n"
        + "        ) CT2\n"
        + ") A\n"
        + " WHERE\n"
        + "    C_ACCTBAL > AVG_ACCTBAL\n"
        + " GROUP BY\n"
        + "    CNTRYCODE\n"
        + " ORDER BY\n"
        + "    CNTRYCODE",
        "{\n"
        + "  \"queryType\" : \"groupBy\",\n"
        + "  \"dataSource\" : {\n"
        + "    \"type\" : \"query\",\n"
        + "    \"query\" : {\n"
        + "      \"queryType\" : \"join\",\n"
        + "      \"dataSources\" : {\n"
        + "        \"orders+customer\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"select.stream\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"query\",\n"
        + "              \"query\" : {\n"
        + "                \"queryType\" : \"join\",\n"
        + "                \"dataSources\" : {\n"
        + "                  \"orders\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"groupBy\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"orders\"\n"
        + "                      },\n"
        + "                      \"granularity\" : {\n"
        + "                        \"type\" : \"all\"\n"
        + "                      },\n"
        + "                      \"dimensions\" : [ {\n"
        + "                        \"type\" : \"default\",\n"
        + "                        \"dimension\" : \"O_CUSTKEY\",\n"
        + "                        \"outputName\" : \"d0\"\n"
        + "                      } ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"outputColumns\" : [ \"d0\" ],\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      },\n"
        + "                      \"descending\" : false\n"
        + "                    }\n"
        + "                  },\n"
        + "                  \"customer\" : {\n"
        + "                    \"type\" : \"query\",\n"
        + "                    \"query\" : {\n"
        + "                      \"queryType\" : \"select.stream\",\n"
        + "                      \"dataSource\" : {\n"
        + "                        \"type\" : \"table\",\n"
        + "                        \"name\" : \"customer\"\n"
        + "                      },\n"
        + "                      \"descending\" : false,\n"
        + "                      \"filter\" : {\n"
        + "                        \"type\" : \"in\",\n"
        + "                        \"dimension\" : \"C_PHONE\",\n"
        + "                        \"values\" : [ \"13\", \"17\", \"18\", \"23\", \"29\", \"30\", \"31\" ],\n"
        + "                        \"extractionFn\" : {\n"
        + "                          \"type\" : \"substring\",\n"
        + "                          \"index\" : 0,\n"
        + "                          \"length\" : 2\n"
        + "                        }\n"
        + "                      },\n"
        + "                      \"columns\" : [ \"C_ACCTBAL\", \"C_CUSTKEY\", \"v0\" ],\n"
        + "                      \"virtualColumns\" : [ {\n"
        + "                        \"type\" : \"expr\",\n"
        + "                        \"expression\" : \"substring(\\\"C_PHONE\\\", 0, 2)\",\n"
        + "                        \"outputName\" : \"v0\"\n"
        + "                      } ],\n"
        + "                      \"limitSpec\" : {\n"
        + "                        \"type\" : \"noop\"\n"
        + "                      },\n"
        + "                      \"context\" : {\n"
        + "                        \"groupby.sort.on.time\" : false,\n"
        + "                        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                      }\n"
        + "                    }\n"
        + "                  }\n"
        + "                },\n"
        + "                \"elements\" : [ {\n"
        + "                  \"joinType\" : \"RO\",\n"
        + "                  \"leftAlias\" : \"orders\",\n"
        + "                  \"leftJoinColumns\" : [ \"d0\" ],\n"
        + "                  \"rightAlias\" : \"customer\",\n"
        + "                  \"rightJoinColumns\" : [ \"C_CUSTKEY\" ]\n"
        + "                } ],\n"
        + "                \"prefixAlias\" : false,\n"
        + "                \"asArray\" : true,\n"
        + "                \"limit\" : 0,\n"
        + "                \"context\" : {\n"
        + "                  \"groupby.sort.on.time\" : false,\n"
        + "                  \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "                },\n"
        + "                \"dataSource\" : {\n"
        + "                  \"type\" : \"union\",\n"
        + "                  \"dataSources\" : [ \"orders\", \"customer\" ]\n"
        + "                },\n"
        + "                \"descending\" : false\n"
        + "              }\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"selector\",\n"
        + "              \"dimension\" : \"d0\",\n"
        + "              \"value\" : \"\"\n"
        + "            },\n"
        + "            \"columns\" : [ \"v0\", \"C_ACCTBAL\" ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        },\n"
        + "        \"customer\" : {\n"
        + "          \"type\" : \"query\",\n"
        + "          \"query\" : {\n"
        + "            \"queryType\" : \"timeseries\",\n"
        + "            \"dataSource\" : {\n"
        + "              \"type\" : \"table\",\n"
        + "              \"name\" : \"customer\"\n"
        + "            },\n"
        + "            \"descending\" : false,\n"
        + "            \"filter\" : {\n"
        + "              \"type\" : \"and\",\n"
        + "              \"fields\" : [ {\n"
        + "                \"type\" : \"in\",\n"
        + "                \"dimension\" : \"C_PHONE\",\n"
        + "                \"values\" : [ \"13\", \"17\", \"18\", \"23\", \"29\", \"30\", \"31\" ],\n"
        + "                \"extractionFn\" : {\n"
        + "                  \"type\" : \"substring\",\n"
        + "                  \"index\" : 0,\n"
        + "                  \"length\" : 2\n"
        + "                }\n"
        + "              }, {\n"
        + "                \"type\" : \"bound\",\n"
        + "                \"dimension\" : \"C_ACCTBAL\",\n"
        + "                \"lower\" : \"0.00\",\n"
        + "                \"lowerStrict\" : true,\n"
        + "                \"upperStrict\" : false,\n"
        + "                \"comparatorType\" : \"numeric\"\n"
        + "              } ]\n"
        + "            },\n"
        + "            \"granularity\" : {\n"
        + "              \"type\" : \"all\"\n"
        + "            },\n"
        + "            \"aggregations\" : [ {\n"
        + "              \"type\" : \"sum\",\n"
        + "              \"name\" : \"a0:sum\",\n"
        + "              \"fieldName\" : \"C_ACCTBAL\",\n"
        + "              \"inputType\" : \"double\"\n"
        + "            }, {\n"
        + "              \"type\" : \"count\",\n"
        + "              \"name\" : \"a0:count\"\n"
        + "            } ],\n"
        + "            \"postAggregations\" : [ {\n"
        + "              \"type\" : \"arithmetic\",\n"
        + "              \"name\" : \"a0\",\n"
        + "              \"fn\" : \"quotient\",\n"
        + "              \"fields\" : [ {\n"
        + "                \"type\" : \"fieldAccess\",\n"
        + "                \"fieldName\" : \"a0:sum\"\n"
        + "              }, {\n"
        + "                \"type\" : \"fieldAccess\",\n"
        + "                \"fieldName\" : \"a0:count\"\n"
        + "              } ]\n"
        + "            } ],\n"
        + "            \"limitSpec\" : {\n"
        + "              \"type\" : \"noop\"\n"
        + "            },\n"
        + "            \"outputColumns\" : [ \"a0\" ],\n"
        + "            \"context\" : {\n"
        + "              \"groupby.sort.on.time\" : false,\n"
        + "              \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "            }\n"
        + "          }\n"
        + "        }\n"
        + "      },\n"
        + "      \"elements\" : [ {\n"
        + "        \"joinType\" : \"INNER\",\n"
        + "        \"leftAlias\" : \"customer\",\n"
        + "        \"leftJoinColumns\" : [ ],\n"
        + "        \"rightAlias\" : \"orders+customer\",\n"
        + "        \"rightJoinColumns\" : [ ]\n"
        + "      } ],\n"
        + "      \"prefixAlias\" : false,\n"
        + "      \"asArray\" : true,\n"
        + "      \"limit\" : 0,\n"
        + "      \"context\" : {\n"
        + "        \"groupby.sort.on.time\" : false,\n"
        + "        \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "      },\n"
        + "      \"dataSource\" : {\n"
        + "        \"type\" : \"union\",\n"
        + "        \"dataSources\" : [ \"customer\", \"orders+customer\" ]\n"
        + "      },\n"
        + "      \"descending\" : false\n"
        + "    }\n"
        + "  },\n"
        + "  \"filter\" : {\n"
        + "    \"type\" : \"math\",\n"
        + "    \"expression\" : \"(\\\"C_ACCTBAL\\\" > \\\"a0\\\")\"\n"
        + "  },\n"
        + "  \"granularity\" : {\n"
        + "    \"type\" : \"all\"\n"
        + "  },\n"
        + "  \"dimensions\" : [ {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"dimension\" : \"v0\",\n"
        + "    \"outputName\" : \"d0\"\n"
        + "  } ],\n"
        + "  \"aggregations\" : [ {\n"
        + "    \"type\" : \"count\",\n"
        + "    \"name\" : \"_a0\"\n"
        + "  }, {\n"
        + "    \"type\" : \"sum\",\n"
        + "    \"name\" : \"_a1\",\n"
        + "    \"fieldName\" : \"C_ACCTBAL\",\n"
        + "    \"inputType\" : \"double\"\n"
        + "  } ],\n"
        + "  \"limitSpec\" : {\n"
        + "    \"type\" : \"default\",\n"
        + "    \"columns\" : [ {\n"
        + "      \"direction\" : \"ascending\",\n"
        + "      \"dimension\" : \"d0\"\n"
        + "    } ],\n"
        + "    \"limit\" : -1\n"
        + "  },\n"
        + "  \"outputColumns\" : [ \"d0\", \"_a0\", \"_a1\" ],\n"
        + "  \"context\" : {\n"
        + "    \"groupby.sort.on.time\" : false,\n"
        + "    \"druid.sql.planner.maxSemiJoinRowsInMemory\" : \"-1;\"\n"
        + "  },\n"
        + "  \"descending\" : false\n"
        + "}"
    );
  }
}