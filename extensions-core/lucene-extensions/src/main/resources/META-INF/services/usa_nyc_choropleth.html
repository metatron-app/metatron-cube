<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
    <style>
      .map {
        height: 700px;
        width: 100%;
      }
    </style>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
    <title>OpenLayers example</title>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script type="text/javascript">

      var format = new ol.format.WKT();
      var inspection_source = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        loader: function(extent, resolution, projection) {
           var proj = projection.getCode();
           // var url = 'https://ahocevar.com/geoserver/wfs?service=WFS&' +
           //     'version=1.1.0&request=GetFeature&typename=osm:water_areas&' +
           //     'outputFormat=application/json&srsname=' + proj + '&' +
           //     'bbox=' + extent.join(',') + ',' + proj;
           var xhr = new XMLHttpRequest();
           xhr.onerror = function() { inspection_source.removeLoadedExtent(extent); };
           xhr.onload = function() {
             if (xhr.status === 200) {
               var format = new ol.format.GeoJSON();
               // console.log('inspection_source ---> ' + xhr.responseText);
               var features = inspection_source.getFormat().readFeatures(xhr.responseText);
               // features.forEach(function (f) {
                    // console.log(f.getGeometry().getCoordinates()); // features are parsed correctly
                // });
               inspection_source.addFeatures(features);
             } else {
               xhr.onerror();
             }
           };
           xhr.open('POST', 'http://localhost:8082/druid/v2/sql/geojson');
           xhr.setRequestHeader('Content-type', 'text/plain');
           var sql = 'WITH NYC AS (' +
                     '   SELECT boro_name, OpCert, PFI FROM nyc_nursing JOIN nyc_boundaries' +
                     '   ON ST_Contains(nyc_boundaries.shape, nyc_nursing.Point)' +
                     ') ' +
                     'SELECT A.boro_name, geom_transform(geom_fromWKT(B.shape), 4326, 3857) as geom, number, OpCerts, PFIs FROM (' +
                     '  SELECT boro_name, count(*) as number, sum(OpCert) as OpCerts, sum(PFI) as PFIs FROM NYC GROUP BY boro_name ' +
                     ') A ' +
                     'JOIN nyc_boundaries B on A.boro_name = B.boro_name';
           console.log('inspection_source fire!! ---> ' + sql);
           xhr.send(sql);
        }
      });

      var inspection = new ol.layer.Vector({
        source: inspection_source,
        style: function (feature) {
          var sum = feature.get('PFIs');
          if (sum > 120000) {
            color = [46, 18, 58, 0.8];
            tcolor = [255,255,255,1];
          } else if (sum > 90000) {
            color = [96, 38, 99, 0.8];
            tcolor = [255,255,255,1];
          } else if (sum > 80000) {
            color = [116, 100, 130, 0.8];
            tcolor = [0,0,0,1];
          } else if (sum > 50000) {
            color = [154, 148, 170, 0.8];
            tcolor = [0,0,0,1];
          } else {
            color = [215, 222, 231, 0.8];
            tcolor = [0,0,0,1];
          }
          return [
            new ol.style.Style({fill: new ol.style.Fill({color: color})}),
            new ol.style.Style({stroke: new ol.style.Stroke({color: [0,0,0], width: 0.3})}),
            new ol.style.Style({text: new ol.style.Text({
                text: feature.get('boro_name') + " = " + feature.get('number') +
                      "\nPFIs = " + feature.get('PFIs'),
                font: 'plain 10px Arial, Verdana, Helvetica, sans-serif',
                fill: new ol.style.Fill({color: tcolor})
              })
            })
          ];
        }
      });

      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({source: new ol.source.OSM()}),
          inspection
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([-73.963136, 40.722619]),
          zoom: 11
        })
      });
    </script>
  </body>
</html>
